

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/url.jpg">
  <link rel="icon" href="/img/url.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="J_0k3r">
  <meta name="keywords" content="">
  
    <meta name="description" content="做做傻瓜 好好打开这夹万吧 讲出口不要怕 -《Let It Out》">
<meta property="og:type" content="article">
<meta property="og:title" content="JAVA内存马查杀">
<meta property="og:url" content="http://example.com/2025/12/07/JAVA%E5%86%85%E5%AD%98%E9%A9%AC%E6%9F%A5%E6%9D%80/index.html">
<meta property="og:site_name" content="J_0k3r">
<meta property="og:description" content="做做傻瓜 好好打开这夹万吧 讲出口不要怕 -《Let It Out》">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/3mm.jpg">
<meta property="article:published_time" content="2025-12-07T05:14:52.000Z">
<meta property="article:modified_time" content="2025-12-07T07:52:04.048Z">
<meta property="article:author" content="J_0k3r">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/img/3mm.jpg">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>JAVA内存马查杀 - J_0k3r</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.7","typing":{"enable":true,"typeSpeed":180,"cursorChar":"_","loop":true,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"python"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":"41fc030db57d5570dd22f78997dc4a7e","google":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":true},"gtag":null},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  
    <!-- Baidu Analytics -->
    <script async>
      if (!Fluid.ctx.dnt) {
        var _hmt = _hmt || [];
        (function() {
          var hm = document.createElement("script");
          hm.src = "https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e";
          var s = document.getElementsByTagName("script")[0];
          s.parentNode.insertBefore(hm, s);
        })();
      }
    </script>
  

  

  

  

  

  



  
<meta name="generator" content="Hexo 5.4.2"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 100vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>J_0k3r的无人之境</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/playlist/" target="_self">
                <i class="iconfont icon-music"></i>
                <span>音乐</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/LetItOut.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="JAVA内存马查杀"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        J_0k3r
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-12-07 13:14" pubdate>
          2025年12月7日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          6.9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          58 分钟
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> 次
        </span>
        
      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">JAVA内存马查杀</h1>
            
              <p id="updated-time" class="note note-info" style="">
                
                  
                    本文最后更新于 2025年12月7日 下午
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <h1 id="初步排查"><a href="#初步排查" class="headerlink" title="初步排查"></a>初步排查</h1><ol>
<li>流量异常：<ul>
<li>出现未知路径的 HTTP 请求（如 <code>/shell</code>, <code>/cmd</code>, <code>/x.jsp</code> 等）。</li>
<li>非业务时间有大量请求或异常 User-Agent。</li>
<li>请求体中包含 Base64 编码、命令执行特征（如 <code>cmd=whoami</code>）。</li>
</ul>
</li>
<li>日志异常：<ul>
<li>访问日志中出现可疑 URL 路径。</li>
<li>Tomcat/Catalina 日志中无对应 JSP 文件却能访问。</li>
</ul>
</li>
<li>进程/端口异常：<ul>
<li>Java 进程监听了非预期端口。</li>
<li>出现反向连接</li>
</ul>
</li>
</ol>
<h1 id="静态分析"><a href="#静态分析" class="headerlink" title="静态分析"></a>静态分析</h1><p>根据不同类型内存马的注入路径或特征反向排查</p>
<h2 id="Servlet-API-类内存马"><a href="#Servlet-API-类内存马" class="headerlink" title="Servlet API 类内存马"></a><strong>Servlet API 类内存马</strong></h2><h3 id="（1）Filter-内存马"><a href="#（1）Filter-内存马" class="headerlink" title="（1）Filter 内存马"></a>（1）Filter 内存马</h3><h4 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h4><p>原理：通过 <code>ServletContext.addFilter()</code> 动态注册 Filter，拦截所有请求。</p>
<p>排查思路：</p>
<ul>
<li>检查运行时注册的 Filter 是否包含未在代码注解/web.xml 中声明的。</li>
<li>关注 Filter 实现类是否来自非业务包（如随机类名、无 package、含 shell 字样）。</li>
<li>Filter的doFilter方法中有恶意代码</li>
</ul>
<p>工具排查</p>
<p><a target="_blank" rel="noopener" href="https://arthas.aliyun.com/arthas-boot.jar">https://arthas.aliyun.com/arthas-boot.jar</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">java -jar .\arthas-boot.jar<br></code></pre></td></tr></table></figure>

<p>注意选择web进程</p>
<p><img src="/mdimg/avamenshell2/1764863040587-b575b285-7a60-487c-b6aa-48c668cf4be5.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">#查看 Mbean 的信息，查看异常Filter节点<br>mbean | grep <span class="hljs-string">&quot;Filter&quot;</span><br>mbean |findstr <span class="hljs-string">&quot;Filter&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1764863440061-169cd5ad-c90e-48b1-b427-e519cb70ffbf.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sc *.Filter   <span class="hljs-comment">//搜索符合pattern的Filter，只能找到通过jsp执行生成的内存马</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1764863161779-3dd36ece-bb01-4e60-a5b8-7f90323ef004.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java">vmtool --action getInstances --className org.apache.catalina.core.StandardContext<br><span class="hljs-comment">//确定web程序下标</span><br><span class="hljs-meta">@StandardContext</span>[][<br>    <span class="hljs-meta">@StandardContext</span>[StandardEngine[Catalina].StandardHost[localhost].StandardContext[/manager]],<br>    <span class="hljs-meta">@StandardContext</span>[StandardEngine[Catalina].StandardHost[localhost].StandardContext[]],<br><span class="hljs-comment">//ROOT下标为1，#ctx = instances[1]</span><br><br>vmtool --action getInstances \<br>       --className org.apache.catalina.core.StandardContext \<br>       --limit <span class="hljs-number">2</span> \<br>       --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#ctx = instances[1],</span><br><span class="hljs-string">#servletContext = #ctx.getServletContext(),</span><br><span class="hljs-string">#registrations = #servletContext.getFilterRegistrations(),</span><br><span class="hljs-string">#registrations != null ? #registrations.keySet().toArray() : new java.lang.Object[]&#123;&quot;getFilterRegistrations() returned null&quot;&#125;</span><br><span class="hljs-string">&#x27;</span> -x <span class="hljs-number">3</span><br><br><span class="hljs-comment">//列出所有filter</span><br><span class="hljs-meta">@Object</span>[][<br>    <span class="hljs-meta">@String</span>[com.example.Myfilter],<br>    <span class="hljs-meta">@String</span>[Tomcat <span class="hljs-title function_">WebSocket</span> <span class="hljs-params">(JSR356)</span> Filter],<br>]<br><br>sc *com.example.Myfilter*<br><span class="hljs-comment">//得到类</span><br>org.apache.jsp.shell2_jsp$Shell2Servlet<br><span class="hljs-comment">//看是否有恶意代码</span><br>jad org.apache.jsp.shell2_jsp<br></code></pre></td></tr></table></figure>

<p>反编译可疑类可以查看是否有恶意代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jad org.apache.jsp.shell_jsp<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1764863258990-8f666b4a-c8a2-4864-b92f-7da36e4df509.png" srcset="/img/loading.gif" lazyload></p>
<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"># 先获取 StandardContext 实例<br>vmtool --action getInstances --className javax.servlet.Filter<br><br><br># 调用 findFilterDefs() 获取所有 Filter 定义（Map&lt;String, FilterDef&gt;）<br>vmtool --action invokeMethod \<br>       --className org.apache.catalina.core.StandardContext \<br>       --object <span class="hljs-number">0x7a3b4c5d</span>（替换为实际的） \<br>       --methodName findFilterDefs \<br>       --paramTypes <span class="hljs-string">&#x27;&#x27;</span> \<br>       --json<br><br><br>输出 所有 Filter 的真实类名 然后反编译分析<br></code></pre></td></tr></table></figure>

<h4 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h4><h5 id="重启web应用（不影响其他tomcat中的web应用）"><a href="#重启web应用（不影响其他tomcat中的web应用）" class="headerlink" title="重启web应用（不影响其他tomcat中的web应用）"></a>重启web应用（不影响其他tomcat中的web应用）</h5><p>但是需要重启受害的web服务</p>
<p>登录tomcat管理页面<code>/manager/html</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java"># 找到你的应用（/），点击 <span class="hljs-string">&quot;Undeploy&quot;</span> → 再 <span class="hljs-string">&quot;Deploy&quot;</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1764865646422-0a602685-d509-4d2d-869e-52ddd183cfd4.png" srcset="/img/loading.gif" lazyload></p>
<h5 id="不关闭web服务的情况下清理"><a href="#不关闭web服务的情况下清理" class="headerlink" title="不关闭web服务的情况下清理"></a>不关闭web服务的情况下清理</h5><p>需要tomcat热加载jsp（默认）</p>
<p>将下面jsp放到web目录</p>
<p>filter_menshell_clean.jsp（通过<code>remove()</code>方法删除数组中的对应项，删除后索引会改变，所以需要一个一个删除，不能选中多个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;% ServletContext servletCtx=request.getServletContext(); StandardContext ctx=<span class="hljs-literal">null</span>; <span class="hljs-keyword">try</span> &#123; Field<br>                                                                                          appctx=servletCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>); appctx.setAccessible(<span class="hljs-literal">true</span>); Object<br>                                                                                          ac=appctx.get(servletCtx); Field stdctx=ac.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>                                                                                          stdctx.setAccessible(<span class="hljs-literal">true</span>); ctx=(StandardContext) stdctx.get(ac); &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>    ctx=(StandardContext) servletCtx.getAttribute(<span class="hljs-string">&quot;org.apache.catalina.CONTEXT&quot;</span>); &#125; <span class="hljs-keyword">if</span> (ctx==<span class="hljs-literal">null</span>) &#123;<br>    out.println(<span class="hljs-string">&quot;&lt;h2&gt;Error: Cannot get StandardContext&lt;/h2&gt;&quot;</span>);<br>    <span class="hljs-keyword">return</span>;<br>&#125;<br><br><span class="hljs-type">Field</span> <span class="hljs-variable">configField</span> <span class="hljs-operator">=</span> ctx.getClass().getDeclaredField(<span class="hljs-string">&quot;filterConfigs&quot;</span>);<br>configField.setAccessible(<span class="hljs-literal">true</span>);<br>Map&lt;String, Object&gt; filterConfigs = (Map&lt;String, Object&gt;) configField.get(ctx);<br><br>Map&lt;String, String&gt; filters = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br><span class="hljs-keyword">if</span> (filterConfigs != <span class="hljs-literal">null</span>) &#123;<br>    <span class="hljs-keyword">for</span> (String name : filterConfigs.keySet()) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">Object</span> <span class="hljs-variable">fc</span> <span class="hljs-operator">=</span> filterConfigs.get(name);<br>            <span class="hljs-type">Field</span> <span class="hljs-variable">f</span> <span class="hljs-operator">=</span> fc.getClass().getDeclaredField(<span class="hljs-string">&quot;filter&quot;</span>);<br>            f.setAccessible(<span class="hljs-literal">true</span>);<br>            <span class="hljs-type">Filter</span> <span class="hljs-variable">filter</span> <span class="hljs-operator">=</span> (Filter) f.get(fc);<br>            filters.put(name, filter.getClass().getName());<br>        &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            filters.put(name, <span class="hljs-string">&quot;[ERROR: &quot;</span> + ex.getMessage() + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br><br>String[] toRemove = request.getParameterValues(<span class="hljs-string">&quot;remove&quot;</span>);<br><span class="hljs-keyword">if</span> (toRemove != <span class="hljs-literal">null</span> &amp;&amp; toRemove.length &gt; <span class="hljs-number">0</span>) &#123;<br>    List&lt;String&gt; removed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (String name : toRemove) &#123;<br>        <span class="hljs-keyword">if</span> (filters.containsKey(name)) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                filterConfigs.remove(name);<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Field</span> <span class="hljs-variable">defsField</span> <span class="hljs-operator">=</span> ctx.getClass().getDeclaredField(<span class="hljs-string">&quot;filterDefs&quot;</span>);<br>                    defsField.setAccessible(<span class="hljs-literal">true</span>);<br>                                                Map<br>                                                &lt;?, ?&gt; defs = (Map<br>                                                &lt;?, ?&gt;) defsField.get(ctx);<br>                                                <span class="hljs-keyword">if</span> (defs <span class="hljs-keyword">instanceof</span> Map) &#123;<br>                                                ((Map) defs).remove(name);<br>                                                &#125;<br>                                                &#125; <span class="hljs-keyword">catch</span> (Exception ignored) &#123;&#125;<br>                                                removed.add(name);<br>                                                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                                                <span class="hljs-comment">// ignore</span><br>                                                &#125;<br>                                                &#125;<br>                                                &#125;<br>                                                <span class="hljs-comment">// FIXED: No multi-line strings!</span><br>                                                out.println(<span class="hljs-string">&quot;&lt;h3&gt;Deleted Filters:&lt;/h3&gt;&quot;</span>);<br>                                                out.println(<span class="hljs-string">&quot;&lt;ul&gt;&quot;</span>);<br>                                                    <span class="hljs-keyword">for</span> (String r : removed) &#123;<br>                                                    out.println(<span class="hljs-string">&quot;&lt;li&gt;&quot;</span> + r + <span class="hljs-string">&quot;&lt;/li&gt;&quot;</span>);<br>                                                    &#125;<br>                                                    out.println(<span class="hljs-string">&quot;&lt;/ul&gt;&quot;</span>);<br>                                                out.println(<span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&#x27;?&#x27;&gt;Back&lt;/a&gt;&lt;/p&gt;&quot;</span>);<br>                                                <span class="hljs-keyword">return</span>;<br>                                                &#125;<br>                                                %&gt;<br>                                                &lt;!DOCTYPE html&gt;<br>                                                &lt;html&gt;<br><br>                                                &lt;head&gt;<br>                                                    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>                                                    &lt;title&gt;Filter Manager&lt;/title&gt;<br>                                                    &lt;style&gt;<br>                                                        body &#123;<br>                                                            font-family: Consolas, monospace;<br>                                                            margin: 20px;<br>                                                            background: #f5f5f5;<br>                                                        &#125;<br><br>                                                        h2 &#123;<br>                                                            color: #1976d2;<br>                                                        &#125;<br><br>                                                        table &#123;<br>                                                            border-collapse: collapse;<br>                                                            width: <span class="hljs-number">100</span>%;<br>                                                            margin: 15px <span class="hljs-number">0</span>;<br>                                                        &#125;<br><br>                                                        th,<br>                                                        td &#123;<br>                                                            border: 1px solid #ccc;<br>                                                            padding: 10px;<br>                                                            text-align: left;<br>                                                        &#125;<br><br>                                                        input[type=checkbox] &#123;<br>                                                            transform: scale(<span class="hljs-number">1.3</span>);<br>                                                            margin-right: 8px;<br>                                                        &#125;<br><br>                                                        button &#123;<br>                                                            padding: 8px 16px;<br>                                                            background: #d32f2f;<br>                                                            color: white;<br>                                                            border: none;<br>                                                            cursor: pointer;<br>                                                            font-weight: bold;<br>                                                        &#125;<br><br>                                                        button:hover &#123;<br>                                                            background: #b71c1c;<br>                                                        &#125;<br>                                                    &lt;/style&gt;<br>                                                &lt;/head&gt;<br><br>                                                &lt;body&gt;<br>                                                    &lt;h2&gt;Filter Manager - Manual Removal&lt;/h2&gt;<br><br>                                                    &lt;% <span class="hljs-keyword">if</span> (filters.isEmpty()) &#123; %&gt;<br>                                                        &lt;p&gt;No filters found.&lt;/p&gt;<br>                                                        &lt;% &#125; <span class="hljs-keyword">else</span> &#123; %&gt;<br>                                                            &lt;form method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>                                                                &lt;table&gt;<br>                                                                    &lt;thead&gt;<br>                                                                        &lt;tr&gt;<br>                                                                            &lt;th&gt;Select&lt;/th&gt;<br>                                                                            &lt;th&gt;Filter Name&lt;/th&gt;<br>                                                                            &lt;th&gt;Class Name&lt;/th&gt;<br>                                                                        &lt;/tr&gt;<br>                                                                    &lt;/thead&gt;<br>                                                                    &lt;tbody&gt;<br>                                                                        &lt;% <span class="hljs-keyword">for</span> (String name : filters.keySet()) &#123; %&gt;<br>                                                                            &lt;tr&gt;<br>                                                                                &lt;td&gt;&lt;input type=<span class="hljs-string">&quot;checkbox&quot;</span> name=<span class="hljs-string">&quot;remove&quot;</span><br>                                                                                        value=<span class="hljs-string">&quot;&lt;%= name %&gt;&quot;</span>&gt;&lt;/td&gt;<br>                                                                                &lt;td&gt;<br>                                                                                    &lt;%= name %&gt;<br>                                                                                &lt;/td&gt;<br>                                                                                &lt;td&gt;<br>                                                                                    &lt;%= filters.get(name) %&gt;<br>                                                                                &lt;/td&gt;<br>                                                                            &lt;/tr&gt;<br>                                                                            &lt;% &#125; %&gt;<br>                                                                    &lt;/tbody&gt;<br>                                                                &lt;/table&gt;<br>                                                                &lt;button type=<span class="hljs-string">&quot;submit&quot;</span><br>                                                                    onclick=<span class="hljs-string">&quot;return confirm(&#x27;Delete selected filters?&#x27;)&quot;</span>&gt;Delete<br>                                                                    Selected&lt;/button&gt;<br>                                                            &lt;/form&gt;<br>                                                            &lt;% &#125; %&gt;<br><br>                                                                &lt;hr&gt;<br>                                                                &lt;p style=<span class="hljs-string">&quot;color: gray; font-size: 12px;&quot;</span>&gt;Delete <span class="hljs-built_in">this</span><br>                                                                    file after use.&lt;/p&gt;<br>                                                &lt;/body&gt;<br><br>                                                &lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>通过反射列出所有filter实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java">JSP/Servlet<br>    ↓ (<span class="hljs-number">1</span>) getServletContext()<br>javax.servlet.ServletContext  ← 接口，运行时是 ApplicationContextFacade<br>    ↓ (<span class="hljs-number">2</span>) 反射读取 <span class="hljs-string">&quot;context&quot;</span> 字段<br>org.apache.catalina.core.ApplicationContext  ← 真实上下文包装类<br>    ↓ (<span class="hljs-number">3</span>) 反射读取 <span class="hljs-string">&quot;context&quot;</span> 字段<br>org.apache.catalina.core.StandardContext     ← 核心！Web 应用的容器实现<br>    ↓ (<span class="hljs-number">4</span>) 反射读取 <span class="hljs-string">&quot;filterConfigs&quot;</span> 字段<br>java.util.Map&lt;String, ApplicationFilterConfig&gt;<br>    ↓ (<span class="hljs-number">5</span>) 遍历每个 ApplicationFilterConfig<br>        → 反射读取其 <span class="hljs-string">&quot;filter&quot;</span> 字段 → 得到 Filter 实例<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1764920919971-56d93715-8fac-4dcd-82b9-a512804e37ed.png" srcset="/img/loading.gif" lazyload></p>
<p>选择已经确定为内存马的filter删除</p>
<p><img src="/mdimg/avamenshell2/1764920999689-252780b2-ff15-437b-8056-ee419d3c8ade.png" srcset="/img/loading.gif" lazyload></p>
<p>在<code>filterConfigs</code> 里删除内存马添加的filter，</p>
<p><img src="/mdimg/avamenshell2/1764921285327-a7c3276f-e9ee-49f5-9bd1-1b98733d06ce.png" srcset="/img/loading.gif" lazyload></p>
<p>也可以通过arthas来做，原理是一样的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//列出所有 Filter 实例，识别可疑项</span><br>vmtool --action getInstances --className javax.servlet.Filter<br><br><span class="hljs-comment">//预期输出（关键线索）：</span><br><span class="hljs-meta">@Filter</span>[][<br>    <span class="hljs-meta">@Myfilter</span>[com.example.Myfilter@283cc9cc],<br>    <span class="hljs-meta">@WsFilter</span>[org.apache.tomcat.websocket.server.WsFilter@42a28ca7],<br>    <span class="hljs-meta">@CsrfPreventionFilter</span>[org.apache.catalina.filters.CsrfPreventionFilter@6c54ab75],<br>    <span class="hljs-meta">@HttpHeaderSecurityFilter</span>[org.apache.catalina.filters.HttpHeaderSecurityFilter@1629399c],<br>    <span class="hljs-meta">@WsFilter</span>[org.apache.tomcat.websocket.server.WsFilter@5895e03c],<br>    <span class="hljs-meta">@Shellfilter</span>[org.apache.jsp.shell_jsp$Shellfilter<span class="hljs-meta">@e84883d</span>]   ← 可疑！<br>]<br><br><span class="hljs-comment">//列出所有 ClassLoader</span><br>classloader --list<br><span class="hljs-comment">//在输出中查找类似以下结构：</span><br>&lt;hash值&gt;    &lt;实例数&gt;    ...    ParallelWebappClassLoader<br>                                 context: /your-app-path<br>或通过其子加载器反推（如 JasperLoader 的 parent）<br>org.apache.jasper.servlet.JasperLoader<span class="hljs-meta">@xxxxxx</span>  ...  ParallelWebappClassLoader<br>Parent 是 AppClassLoader 或 URLClassLoader<br>记录其 hash 值（如 a1b2c3d4）——这就是你要用的 -c 参数<br><br><span class="hljs-comment">//验证 ClassLoader 是否有效</span><br>ognl -c &lt;你的hash&gt; <span class="hljs-string">&quot;new java.lang.String(&#x27;OK&#x27;)&quot;</span><br>若返回 <span class="hljs-string">&quot;OK&quot;</span>，说明 hash 可用。<br><br><span class="hljs-comment">//清除指定 Filter（核心命令）</span><br><span class="hljs-comment">//将 &lt;你的hash&gt; 替换为第二步获取的值，&lt;FilterName&gt; 替换为第一步记下的简单类名（如 Shellfilter）：</span><br>ognl -c &lt;你的hash&gt; <span class="hljs-string">&quot;#c=@java.lang.Thread@currentThread().getContextClassLoader(),#f=#c.getClass().getSuperclass().getDeclaredField(\&quot;resources\&quot;),#f.setAccessible(true),#r=#f.get(#c),#g=#r.getClass().getDeclaredField(\&quot;context\&quot;),#g.setAccessible(true),#ctx=#g.get(#r),#fcField=#ctx.getClass().getDeclaredField(\&quot;filterConfigs\&quot;),#fdField=#ctx.getClass().getDeclaredField(\&quot;filterDefs\&quot;),#fcField.setAccessible(true),#fdField.setAccessible(true),#fc=(java.util.Map)#fcField.get(#ctx),#fd=(java.util.Map)#fdField.get(#ctx),#fc.remove(\&quot;&lt;FilterName&gt;\&quot;),#fd.remove(\&quot;&lt;FilterName&gt;\&quot;)&quot;</span><br><br><span class="hljs-comment">//验证是否清除成功</span><br>ognl -c &lt;你的hash&gt; <span class="hljs-string">&quot;#c=@java.lang.Thread@currentThread().getContextClassLoader(),#f=#c.getClass().getSuperclass().getDeclaredField(\&quot;resources\&quot;),#f.setAccessible(true),#r=#f.get(#c),#g=#r.getClass().getDeclaredField(\&quot;context\&quot;),#g.setAccessible(true),#ctx=#g.get(#r),#h=#ctx.getClass().getDeclaredField(\&quot;filterConfigs\&quot;),#h.setAccessible(true),#fc=(java.util.Map)#h.get(#ctx),#fc.keySet()&quot;</span><br></code></pre></td></tr></table></figure>

<p>⚠️ 注意： </p>
<p>已经在执行的请求不受影响（Filter 实例可能还在内存中） </p>
<p>新请求将不再触发该 Filter 这不是“卸载类”，只是断开容器对它的引用 </p>
<p>也就是说如果已经通过内存马执行反弹shell，删除filter不会断开反弹shell连接</p>
<h3 id="（2）Servlet-内存马"><a href="#（2）Servlet-内存马" class="headerlink" title="（2）Servlet 内存马"></a>（2）Servlet 内存马</h3><h4 id="排查-1"><a href="#排查-1" class="headerlink" title="排查"></a>排查</h4><p>原理：通过 <code>ServletContext.addServlet()</code> 动态注册 Servlet，绑定特定路径（如 <code>/cmd</code>）。</p>
<p>排查思路：</p>
<ul>
<li>检查运行时注册的 Servlet 名称和映射路径。</li>
<li>对比源码/Web.xml，确认是否多出未知 Servlet。</li>
<li>检查 Servlet 的 service/doGet/doPost 方法中是否存在可疑行为</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">#查看 Mbean 的信息，查看异常Filter节点<br>mbean | grep <span class="hljs-string">&quot;Filter&quot;</span><br>mbean |findstr <span class="hljs-string">&quot;Filter&quot;</span><br><br><span class="hljs-comment">//或者</span><br>sc *.Servlet  <span class="hljs-comment">//只能找到通过jsp执行生成的内存马</span><br><br><span class="hljs-comment">//然后反编译可疑类分析</span><br>jad org.apache.jsp.shell2_jsp<br></code></pre></td></tr></table></figure>

<p>或者</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"># 先获取 StandardContext 实例（通常可通过已知的 ServletContext 间接获取）<br>vmtool --action getInstances --className org.apache.catalina.core.StandardContext<br><br># 调用 findChild() 或遍历 children 获取所有 Wrapper（即 Servlet 封装）<br># 更推荐直接调用 findServlets()（若存在）或 getChildNames() + findChild()<br># 但 Tomcat 中常用方式是通过 findChildren() 获取所有子容器（包括 Servlet）<br><br>vmtool --action invokeMethod \<br>       --className org.apache.catalina.core.StandardContext \<br>       --object <span class="hljs-number">0x7a3b4c5d</span> \<br>       --methodName findChildren \<br>       --paramTypes <span class="hljs-string">&#x27;&#x27;</span> \<br>       --json<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java">vmtool --action getInstances --className org.apache.catalina.core.StandardContext<br><span class="hljs-comment">//确定web程序下标</span><br><span class="hljs-meta">@StandardContext</span>[][<br>    <span class="hljs-meta">@StandardContext</span>[StandardEngine[Catalina].StandardHost[localhost].StandardContext[/manager]],<br>    <span class="hljs-meta">@StandardContext</span>[StandardEngine[Catalina].StandardHost[localhost].StandardContext[]],<br><span class="hljs-comment">//ROOT下标为1，#ctx = instances[1]</span><br><br>vmtool --action getInstances \<br>       --className org.apache.catalina.core.StandardContext \<br>       --limit <span class="hljs-number">2</span> \<br>       --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#ctx = instances[1],</span><br><span class="hljs-string">#servletContext = #ctx.getServletContext(),</span><br><span class="hljs-string">#registrations = #servletContext.getServletRegistrations(),</span><br><span class="hljs-string">#registrations != null ? #registrations.keySet().toArray() : new java.lang.Object[]&#123;&quot;getServletRegistrations() returned null&quot;&#125;</span><br><span class="hljs-string">&#x27;</span> -x <span class="hljs-number">3</span><br><br><span class="hljs-comment">//列出所有filter</span><br><span class="hljs-meta">@Object</span>[][<br>    <span class="hljs-meta">@String</span>[Shell2Servlet],<br>    <span class="hljs-meta">@String</span>[<span class="hljs-keyword">default</span>],<br>    <span class="hljs-meta">@String</span>[com.example.MyServlet],<br>    <span class="hljs-meta">@String</span>[jsp],<br>]<br><br>sc *Shell2Servlet*<br><span class="hljs-comment">//得到类</span><br>org.apache.jsp.shell2_jsp$Shell2Servlet<br><span class="hljs-comment">//看是否有恶意代码</span><br>jad org.apache.jsp.shell2_jsp<br></code></pre></td></tr></table></figure>

<h4 id="清理-1"><a href="#清理-1" class="headerlink" title="清理"></a>清理</h4><p>在允许重启web服务的情况下可以通过tomcat后台或者命令行来重启受害的web服务</p>
<p>或者不重启web服务，通过jsp热加载</p>
<p>clean_servlet_memshell.jsp（通过<code>remove()</code>方法删除数组中的对应项，删除后索引会改变，所以需要一个一个删除，不能选中多个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Container&quot;</span> %&gt;<br><br>&lt;%<br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletCtx</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">ac</span> <span class="hljs-operator">=</span> appctx.get(servletCtx);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> ac.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        ctx = (StandardContext) stdctx.get(ac);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ctx = (StandardContext) servletCtx.getAttribute(<span class="hljs-string">&quot;org.apache.catalina.CONTEXT&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ctx == <span class="hljs-literal">null</span>) &#123;<br>        out.println(<span class="hljs-string">&quot;&lt;h2&gt;Error: Cannot get StandardContext&lt;/h2&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 使用 findChildren() 获取所有 Wrapper（Servlet）</span><br>    <span class="hljs-type">Method</span> <span class="hljs-variable">findChildrenMethod</span> <span class="hljs-operator">=</span> ctx.getClass().getMethod(<span class="hljs-string">&quot;findChildren&quot;</span>);<br>    Container[] wrappers = (Container[]) findChildrenMethod.invoke(ctx);<br><br>    <span class="hljs-comment">// 构建 servletInfo: name -&gt; className</span><br>    Map&lt;String, String&gt; servletInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Container wrapper : wrappers) &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> wrapper.getName();<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">getServletClassMethod</span> <span class="hljs-operator">=</span> wrapper.getClass().getMethod(<span class="hljs-string">&quot;getServletClass&quot;</span>);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> (String) getServletClassMethod.invoke(wrapper);<br>            servletInfo.put(name, className != <span class="hljs-literal">null</span> ? className : <span class="hljs-string">&quot;[No Class]&quot;</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>            servletInfo.put(wrapper.getName(), <span class="hljs-string">&quot;[ERROR: &quot;</span> + ex.getMessage() + <span class="hljs-string">&quot;]&quot;</span>);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理删除</span><br>    String[] toRemove = request.getParameterValues(<span class="hljs-string">&quot;remove&quot;</span>);<br>    <span class="hljs-keyword">if</span> (toRemove != <span class="hljs-literal">null</span> &amp;&amp; toRemove.length &gt; <span class="hljs-number">0</span>) &#123;<br>        List&lt;String&gt; removed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-type">Method</span> <span class="hljs-variable">removeChildMethod</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            removeChildMethod = ctx.getClass().getMethod(<span class="hljs-string">&quot;removeChild&quot;</span>, Container.class);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-comment">// fallback to superclass</span><br>            removeChildMethod = ctx.getClass().getSuperclass().getMethod(<span class="hljs-string">&quot;removeChild&quot;</span>, Container.class);<br>        &#125;<br>        removeChildMethod.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-keyword">for</span> (String name : toRemove) &#123;<br>            <span class="hljs-keyword">if</span> (servletInfo.containsKey(name)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">// 找到对应的 Wrapper</span><br>                    <span class="hljs-type">Container</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                    <span class="hljs-keyword">for</span> (Container w : wrappers) &#123;<br>                        <span class="hljs-keyword">if</span> (name.equals(w.getName())) &#123;<br>                            target = w;<br>                            <span class="hljs-keyword">break</span>;<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> (target != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// 调用 removeChild</span><br>                        removeChildMethod.invoke(ctx, target);<br>                        removed.add(name);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                    <span class="hljs-comment">// ignore</span><br>                &#125;<br>            &#125;<br>        &#125;<br><br>        out.println(<span class="hljs-string">&quot;&lt;h3&gt;Deleted Servlets:&lt;/h3&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;ul&gt;&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String r : removed) &#123;<br>            out.println(<span class="hljs-string">&quot;&lt;li&gt;&quot;</span> + r + <span class="hljs-string">&quot;&lt;/li&gt;&quot;</span>);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;/ul&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&#x27;?&#x27;&gt;Back&lt;/a&gt;&lt;/p&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>%&gt;<br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;Servlet <span class="hljs-title function_">Manager</span> <span class="hljs-params">(Tomcat <span class="hljs-number">9</span>+ Compatible)</span>&lt;/title&gt;<br>    &lt;style&gt;<br>        body &#123; font-family: Consolas, monospace; margin: 20px; background: #f5f5f5; &#125;<br>        h2 &#123; color: #1976d2; &#125;<br>        table &#123; border-collapse: collapse; width: <span class="hljs-number">100</span>%; margin: 15px <span class="hljs-number">0</span>; &#125;<br>        th, td &#123; border: 1px solid #ccc; padding: 10px; text-align: left; &#125;<br>        input[type=checkbox] &#123; transform: scale(<span class="hljs-number">1.3</span>); margin-right: 8px; &#125;<br>        button &#123; padding: 8px 16px; background: #d32f2f; color: white; border: none; cursor: pointer; font-weight: bold; &#125;<br>        button:hover &#123; background: #b71c1c; &#125;<br>    &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>    &lt;h2&gt;Servlet Manager - Manual <span class="hljs-title function_">Removal</span> <span class="hljs-params">(Tomcat <span class="hljs-number">9</span>+)</span>&lt;/h2&gt;<br><br>    &lt;% <span class="hljs-keyword">if</span> (servletInfo.isEmpty()) &#123; %&gt;<br>        &lt;p&gt;No servlets found.&lt;/p&gt;<br>    &lt;% &#125; <span class="hljs-keyword">else</span> &#123; %&gt;<br>        &lt;form method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>            &lt;table&gt;<br>                &lt;thead&gt;<br>                    &lt;tr&gt;<br>                        &lt;th&gt;Select&lt;/th&gt;<br>                        &lt;th&gt;Servlet Name&lt;/th&gt;<br>                        &lt;th&gt;Class Name&lt;/th&gt;<br>                    &lt;/tr&gt;<br>                &lt;/thead&gt;<br>                &lt;tbody&gt;<br>                    &lt;% <span class="hljs-keyword">for</span> (String name : servletInfo.keySet()) &#123; %&gt;<br>                        &lt;tr&gt;<br>                            &lt;td&gt;&lt;input type=<span class="hljs-string">&quot;checkbox&quot;</span> name=<span class="hljs-string">&quot;remove&quot;</span> value=<span class="hljs-string">&quot;&lt;%= name %&gt;&quot;</span>&gt;&lt;/td&gt;<br>                            &lt;td&gt;&lt;%= name %&gt;&lt;/td&gt;<br>                            &lt;td&gt;&lt;%= servletInfo.get(name) %&gt;&lt;/td&gt;<br>                        &lt;/tr&gt;<br>                    &lt;% &#125; %&gt;<br>                &lt;/tbody&gt;<br>            &lt;/table&gt;<br>            &lt;button type=<span class="hljs-string">&quot;submit&quot;</span> onclick=<span class="hljs-string">&quot;return confirm(&#x27;Delete selected servlets?&#x27;)&quot;</span>&gt;Delete Selected&lt;/button&gt;<br>        &lt;/form&gt;<br>    &lt;% &#125; %&gt;<br><br>    &lt;hr&gt;<br>    &lt;p style=<span class="hljs-string">&quot;color: gray; font-size: 12px;&quot;</span>&gt;⚠️ Delete <span class="hljs-built_in">this</span> file after use!&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1764929483120-bbbc98ca-6111-4b60-8a67-8506807e524e.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs java"># 列出所有 javax.servlet.Servlet 实例<br>vmtool --action getInstances --className javax.servlet.Servlet<br><br><span class="hljs-comment">//预期输出（关键线索）：</span><br><span class="hljs-meta">@Servlet</span>[][<br>    <span class="hljs-meta">@DefaultServlet</span>[org.apache.catalina.servlets.DefaultServlet@1a2b3c4d],<br>    <span class="hljs-meta">@JspServlet</span>[org.apache.jasper.servlet.JspServlet@5e6f7g8h],<br>    <span class="hljs-meta">@MyShellServlet</span>[com.example.MyShellServlet@9i0j1k2l],        ← 可疑！<br>    <span class="hljs-meta">@Shell</span>[org.apache.jsp.shell_jsp$Shell<span class="hljs-meta">@abc12345</span>]              ← 高危！<br>]<br><br><br># 列出所有 ClassLoader<br>classloader --list<br><span class="hljs-comment">//在输出中查找你的 Web 应用对应的 ParallelWebappClassLoader，例如：</span><br>a1b2c3d4   <span class="hljs-number">1</span>      ...    ParallelWebappClassLoader<br>                         context: /myapp<br><span class="hljs-comment">//或通过子加载器反推（如 JasperLoader 的 parent）：</span><br>org.apache.jasper.servlet.JasperLoader<span class="hljs-meta">@xxxxxx</span><br>  parent -&gt; ParallelWebappClassLoader<span class="hljs-meta">@a1b2c3d4</span><br><span class="hljs-comment">//验证 hash 是否有效：</span><br>ognl -c a1b2c3d4 <span class="hljs-string">&quot;new java.lang.String(&#x27;OK&#x27;)&quot;</span><br># 若返回 <span class="hljs-string">&quot;OK&quot;</span>，说明可用<br><br><br>ognl -c &lt;你的hash&gt; <span class="hljs-string">&#x27;</span><br><span class="hljs-string">  #c=@java.lang.Thread@currentThread().getContextClassLoader(),</span><br><span class="hljs-string">  #f=#c.getClass().getSuperclass().getDeclaredField(&quot;resources&quot;),</span><br><span class="hljs-string">  #f.setAccessible(true),</span><br><span class="hljs-string">  #r=#f.get(#c),</span><br><span class="hljs-string">  #g=#r.getClass().getDeclaredField(&quot;context&quot;),</span><br><span class="hljs-string">  #g.setAccessible(true),</span><br><span class="hljs-string">  #ctx=#g.get(#r),</span><br><span class="hljs-string"></span><br><span class="hljs-string">  // 获取 children 字段（Map&lt;String, Wrapper&gt;）</span><br><span class="hljs-string">  #childrenField=#ctx.getClass().getSuperclass().getDeclaredField(&quot;children&quot;),</span><br><span class="hljs-string">  #childrenField.setAccessible(true),</span><br><span class="hljs-string">  #children=(java.util.Map)#childrenField.get(#ctx),</span><br><span class="hljs-string"></span><br><span class="hljs-string">  // 获取 servletMappings 字段（Map&lt;String, String&gt;）</span><br><span class="hljs-string">  #mappingsField=#ctx.getClass().getSuperclass().getDeclaredField(&quot;servletMappings&quot;),</span><br><span class="hljs-string">  #mappingsField.setAccessible(true),</span><br><span class="hljs-string">  #mappings=(java.util.Map)#mappingsField.get(#ctx),</span><br><span class="hljs-string"></span><br><span class="hljs-string">  // 要删除的 Servlet 名称（注意：不是类名！是注册时的 name）</span><br><span class="hljs-string">  #servletName=&quot;&lt;ServletName&gt;&quot;,</span><br><span class="hljs-string"></span><br><span class="hljs-string">  // 从 children 中移除 Wrapper</span><br><span class="hljs-string">  #wrapper=#children.remove(#servletName),</span><br><span class="hljs-string"></span><br><span class="hljs-string">  // 从 servletMappings 中移除所有指向该 name 的映射</span><br><span class="hljs-string">  #it=#mappings.entrySet().iterator(),</span><br><span class="hljs-string">  #removedMappings=&#123;&#125;,</span><br><span class="hljs-string">  &#123;</span><br><span class="hljs-string">    while (#it.hasNext()) &#123;</span><br><span class="hljs-string">      #entry=#it.next(),</span><br><span class="hljs-string">      if (#entry.value.equals(#servletName)) &#123;</span><br><span class="hljs-string">        #it.remove()</span><br><span class="hljs-string">      &#125;</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">  &#125;,</span><br><span class="hljs-string"></span><br><span class="hljs-string">  &quot;Removed servlet: &quot; + #servletName + &quot;, wrapper=&quot; + (#wrapper != null ? &quot;OK&quot; : &quot;NOT_FOUND&quot;)</span><br><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="（3）Listener-内存马"><a href="#（3）Listener-内存马" class="headerlink" title="（3）Listener 内存马"></a>（3）Listener 内存马</h3><h4 id="排查-2"><a href="#排查-2" class="headerlink" title="排查"></a>排查</h4><p>原理：较少见，但可通过 <code>ServletContext.addListener()</code> 注册 <code>ServletContextListener</code> 或 <code>ServletRequestListener</code>，在请求前后执行恶意逻辑。</p>
<p>排查思路：</p>
<ul>
<li>Listener 通常在应用启动时注册，动态添加较难触发，但仍需检查。</li>
<li>重点看 <code>ServletRequestListener</code>（listener内存马中唯一能命令执行的并且无法回显只能外带），可拦截请求/响应。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java">sc *ServletRequestListener*<br>sc *ServletContextListener*<br>sc *HttpSessionListener*<br><span class="hljs-comment">//只能找到通过jsp执行生成的内存马</span><br></code></pre></td></tr></table></figure>

<p>用clean_listener_memshell.jsp列出所有listener的实现类</p>
<p>然后对可疑类用arthas反编译排查看是否有恶意代码</p>
<p><img src="/mdimg/avamenshell2/1765000575927-a5665482-64bb-4ce8-a5c4-a38531dafb09.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="清理-2"><a href="#清理-2" class="headerlink" title="清理"></a>清理</h4><p>tomat管理页面重启web应用</p>
<p>或者</p>
<p>clean_listener_memshell.jsp（通过<code>remove()</code>方法删除数组中的对应项，删除后索引会改变，所以需要一个一个删除，不能选中多个）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br><br>&lt;%<br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletCtx</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">ac</span> <span class="hljs-operator">=</span> appctx.get(servletCtx);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> ac.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        ctx = (StandardContext) stdctx.get(ac);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ctx = (StandardContext) servletCtx.getAttribute(<span class="hljs-string">&quot;org.apache.catalina.CONTEXT&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ctx == <span class="hljs-literal">null</span>) &#123;<br>        out.println(<span class="hljs-string">&quot;&lt;h2&gt;Error: Cannot get StandardContext&lt;/h2&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-type">Field</span> <span class="hljs-variable">listenersField</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        listenersField = ctx.getClass().getDeclaredField(<span class="hljs-string">&quot;applicationEventListenersList&quot;</span>);<br>    &#125; <span class="hljs-keyword">catch</span> (NoSuchFieldException e) &#123;<br>        listenersField = ctx.getClass().getSuperclass().getDeclaredField(<span class="hljs-string">&quot;applicationEventListenersList&quot;</span>);<br>    &#125;<br>    listenersField.setAccessible(<span class="hljs-literal">true</span>);<br>    <span class="hljs-meta">@SuppressWarnings(&quot;unchecked&quot;)</span><br>    List&lt;Object&gt; listeners = (List&lt;Object&gt;) listenersField.get(ctx);<br><br>    Map&lt;Integer, String&gt; listenerInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; listeners.size(); i++) &#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">listener</span> <span class="hljs-operator">=</span> listeners.get(i);<br>        listenerInfo.put(i, listener != <span class="hljs-literal">null</span> ? listener.getClass().getName() : <span class="hljs-string">&quot;[NULL]&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// ✅ 正确声明 toRemove</span><br>    String[] toRemove = request.getParameterValues(<span class="hljs-string">&quot;remove&quot;</span>);<br>    <span class="hljs-keyword">if</span> (toRemove != <span class="hljs-literal">null</span> &amp;&amp; toRemove.length &gt; <span class="hljs-number">0</span>) &#123;<br>        List&lt;String&gt; removed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (String idxStr : toRemove) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> Integer.parseInt(idxStr);<br>                <span class="hljs-keyword">if</span> (listenerInfo.containsKey(idx)) &#123;<br>                    listeners.remove(idx);<br>                    removed.add(<span class="hljs-string">&quot;Index &quot;</span> + idx + <span class="hljs-string">&quot; (&quot;</span> + listenerInfo.get(idx) + <span class="hljs-string">&quot;)&quot;</span>);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                <span class="hljs-comment">// ignore invalid index</span><br>            &#125;<br>        &#125;<br><br>        out.println(<span class="hljs-string">&quot;&lt;h3&gt;Deleted Listeners:&lt;/h3&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;ul&gt;&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String r : removed) &#123;<br>            out.println(<span class="hljs-string">&quot;&lt;li&gt;&quot;</span> + r + <span class="hljs-string">&quot;&lt;/li&gt;&quot;</span>);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;/ul&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&#x27;?&#x27;&gt;Back&lt;/a&gt;&lt;/p&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>%&gt;<br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;Listener Cleaner&lt;/title&gt;<br>    &lt;style&gt;<br>        body &#123; font-family: Consolas, monospace; margin: 20px; background: #f9f9f9; &#125;<br>        h2 &#123; color: #c62828; &#125;<br>        table &#123; border-collapse: collapse; width: <span class="hljs-number">100</span>%; margin: 15px <span class="hljs-number">0</span>; &#125;<br>        th, td &#123; border: 1px solid #ddd; padding: 10px; text-align: left; &#125;<br>        input[type=checkbox] &#123; transform: scale(<span class="hljs-number">1.2</span>); &#125;<br>        button &#123; padding: 8px 16px; background: #d32f2f; color: white; border: none; cursor: pointer; &#125;<br>    &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h2&gt;ServletRequestListener Memory Shell Remover&lt;/h2&gt;<br><br>&lt;% <span class="hljs-keyword">if</span> (listenerInfo.isEmpty()) &#123; %&gt;<br>&lt;p&gt;No listeners found.&lt;/p&gt;<br>&lt;% &#125; <span class="hljs-keyword">else</span> &#123; %&gt;<br>&lt;form method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>    &lt;table&gt;<br>        &lt;thead&gt;<br>        &lt;tr&gt;<br>            &lt;th&gt;Select&lt;/th&gt;<br>            &lt;th&gt;Index&lt;/th&gt;<br>            &lt;th&gt;Class Name&lt;/th&gt;<br>        &lt;/tr&gt;<br>        &lt;/thead&gt;<br>        &lt;tbody&gt;<br>        &lt;% <span class="hljs-keyword">for</span> (Integer idx : listenerInfo.keySet()) &#123; %&gt;<br>        &lt;tr&gt;<br>            &lt;td&gt;&lt;input type=<span class="hljs-string">&quot;checkbox&quot;</span> name=<span class="hljs-string">&quot;remove&quot;</span> value=<span class="hljs-string">&quot;&lt;%= idx %&gt;&quot;</span>&gt;&lt;/td&gt;<br>            &lt;td&gt;&lt;%= idx %&gt;&lt;/td&gt;<br>            &lt;td&gt;&lt;%= listenerInfo.get(idx) %&gt;&lt;/td&gt;<br>        &lt;/tr&gt;<br>        &lt;% &#125; %&gt;<br>        &lt;/tbody&gt;<br>    &lt;/table&gt;<br>    &lt;button type=<span class="hljs-string">&quot;submit&quot;</span> onclick=<span class="hljs-string">&quot;return confirm(&#x27;Confirm deletion?&#x27;)&quot;</span>&gt;Delete Selected&lt;/button&gt;<br>&lt;/form&gt;<br>&lt;% &#125; %&gt;<br><br>&lt;hr&gt;<br>&lt;p style=<span class="hljs-string">&quot;color: red; font-size: 12px;&quot;</span>&gt;⚠️ Delete <span class="hljs-built_in">this</span> file immediately after use!&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">读取 Tomcat StandardContext 中的字段：applicationEventListenersList（包含实现了 ServletContextListener、HttpSessionListener、ServletRequestListener 等接口的监听器）<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765000172021-656af40e-996f-4c29-ae12-0d1f93c81fc4.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Spring-类内存马"><a href="#Spring-类内存马" class="headerlink" title="Spring 类内存马"></a><strong>Spring 类内存马</strong></h2><h3 id="（1）Spring-Controller-内存马"><a href="#（1）Spring-Controller-内存马" class="headerlink" title="（1）Spring Controller 内存马"></a>（1）Spring Controller 内存马</h3><h4 id="排查-3"><a href="#排查-3" class="headerlink" title="排查"></a>排查</h4><p>原理：通过操作 <code>RequestMappingHandlerMapping</code> 动态注册新的 <code>@RequestMapping</code> 映射。</p>
<p>排查思路：</p>
<ul>
<li>检查 Spring MVC 的 HandlerMappings 中是否存在未定义的 URL 映射。</li>
<li>恶意 Controller 通常无源码、类名随机、方法含 <code>eval</code>/<code>exec</code>。</li>
</ul>
<p>arthas</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java">vmtool --action getInstances --classLoaderHash <span class="hljs-number">5e481248</span> --className org.springframework.web.servlet.DispatcherServlet --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">    instances[0].getWebApplicationContext()</span><br><span class="hljs-string">        .getBean(&quot;requestMappingHandlerMapping&quot;)</span><br><span class="hljs-string">        .getHandlerMethods()</span><br><span class="hljs-string">        .keySet()</span><br><span class="hljs-string">        .toArray()</span><br><span class="hljs-string">&#x27;</span><br><br>输出所有路由，查看是否存在可疑路由<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sc *Controller*<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765010993727-10922ae6-1ecc-4757-b3c0-7beed9be79e1.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jad com.example.demo.InjectMemshellController<br></code></pre></td></tr></table></figure>

<p>反编译分析可疑类</p>
<p><img src="/mdimg/avamenshell2/1765011086779-64a8ccd3-8af5-48e5-99b6-4cd98ce2a922.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="清理-3"><a href="#清理-3" class="headerlink" title="清理"></a>清理</h4><p> 重启jvm（根治）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java">ognl -x <span class="hljs-number">5</span> <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#ds=@org.springframework.web.servlet.DispatcherServlet@4fc142ec,</span><br><span class="hljs-string">#ctx=#ds.getWebApplicationContext(),</span><br><span class="hljs-string">#mapping=#ctx.getBean(&quot;requestMappingHandlerMapping&quot;),</span><br><span class="hljs-string">#field=#mapping.getClass().getDeclaredField(&quot;handlerMethods&quot;),</span><br><span class="hljs-string">#field.setAccessible(true),</span><br><span class="hljs-string">#handlerMethods=(java.util.Map)#field.get(#mapping),</span><br><span class="hljs-string">#iter=#handlerMethods.entrySet().iterator(),</span><br><span class="hljs-string">#removed=0,</span><br><span class="hljs-string">while(#iter.hasNext())&#123;</span><br><span class="hljs-string">    #entry=#iter.next(),</span><br><span class="hljs-string">    #method=#entry.value.getMethod(),</span><br><span class="hljs-string">    #className=#method.declaringClass.name,</span><br><span class="hljs-string">    // 👇 修改这里的条件，匹配你的可疑类名</span><br><span class="hljs-string">    if(#className.contains(&quot;Object$&quot;) || #className.contains(&quot;Evil&quot;) || #className.startsWith(&quot;com.attacker&quot;))&#123;</span><br><span class="hljs-string">        #iter.remove(),</span><br><span class="hljs-string">        #removed++,</span><br><span class="hljs-string">        println(&quot;Removed: &quot; + #className + &quot; -&gt; &quot; + #entry.key.getPatternsCondition().getPatterns())</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string">&#125;,</span><br><span class="hljs-string">&quot;Total removed: &quot; + #removed</span><br><span class="hljs-string">&#x27;</span><br></code></pre></td></tr></table></figure>

<h3 id="（2）Spring-Interceptor-内存马"><a href="#（2）Spring-Interceptor-内存马" class="headerlink" title="（2）Spring Interceptor 内存马"></a>（2）Spring Interceptor 内存马</h3><h4 id="排查-4"><a href="#排查-4" class="headerlink" title="排查"></a>排查</h4><p>原理：向 <code>HandlerMapping</code> 或 <code>WebMvcConfigurer</code> 动态添加 Interceptor，拦截请求。</p>
<p>排查思路：</p>
<ul>
<li>检查 <code>HandlerExecutionChain</code> 中的 interceptors。</li>
<li>拦截器类若非项目代码，可疑。</li>
<li>寻找可疑路由</li>
<li>查看流量日志</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sc *Interceptor*<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765012515606-35e5d852-31d2-43ed-a961-b58472fbb23d.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java">vmtool --action getInstances \<br>       --classLoaderHash <span class="hljs-number">5e481248</span> \<br>       --className org.springframework.web.servlet.DispatcherServlet \<br>       --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#m = instances[0].getWebApplicationContext().getBean(&quot;requestMappingHandlerMapping&quot;),</span><br><span class="hljs-string">#m.getClass().name + &quot; -&gt; &quot; +</span><br><span class="hljs-string">#m.getClass().superclass.name + &quot; -&gt; &quot; +</span><br><span class="hljs-string">#m.getClass().superclass.superclass.name + &quot; -&gt; &quot; +</span><br><span class="hljs-string">#m.getClass().superclass.superclass.superclass.name</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-comment">//输出</span><br><span class="hljs-meta">@String</span>[org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping -&gt; org.springframework.web.servlet.mvc.method.RequestMappingInfoHandlerMapping -&gt; org.springframework.web.servlet.handler.AbstractHandlerMethodMapping -&gt; org.springframework.web.servlet.handler.AbstractHandlerMapping]<br><br><br>vmtool --action getInstances \<br>       --classLoaderHash <span class="hljs-number">5e481248</span> \<br>       --className org.springframework.web.servlet.DispatcherServlet \<br>       --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#m = instances[0].getWebApplicationContext().getBean(&quot;requestMappingHandlerMapping&quot;),</span><br><span class="hljs-string">#f = #m.getClass().getSuperclass().getSuperclass().getSuperclass().getDeclaredField(&quot;adaptedInterceptors&quot;),</span><br><span class="hljs-string">#f.setAccessible(true),</span><br><span class="hljs-string">#list = #f.get(#m),</span><br><span class="hljs-string">#list.&#123;class.name&#125;</span><br><span class="hljs-string">&#x27;</span> -x <span class="hljs-number">3</span><br><br><span class="hljs-comment">//这里用了 .getSuperclass().getSuperclass().getSuperclass()（三次），正好到达 AbstractHandlerMapping。</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765013952442-53c87445-0ec6-4b1a-bfb9-1e99f8861cc4.png" srcset="/img/loading.gif" lazyload></p>
<p>依旧jad反编译可疑类分析</p>
<h4 id="清理-4"><a href="#清理-4" class="headerlink" title="清理"></a>清理</h4><p>重启jvm（根治）</p>
<p>arthas删除<code>adaptedInterceptors</code> 中的恶意<code>Interceptor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java">vmtool --action getInstances \<br>       --classLoaderHash <span class="hljs-number">5e481248</span> \<br>       --className org.springframework.web.servlet.DispatcherServlet \<br>       --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#m = instances[0].getWebApplicationContext().getBean(&quot;requestMappingHandlerMapping&quot;),</span><br><span class="hljs-string">#f = #m.getClass().getSuperclass().getSuperclass().getSuperclass().getDeclaredField(&quot;adaptedInterceptors&quot;),</span><br><span class="hljs-string">#f.setAccessible(true),</span><br><span class="hljs-string">#list = #f.get(#m),</span><br><span class="hljs-string">#bad = #list.&#123;? #this.class.name == &quot;com.example.demo.InterceptorMemShell$1&quot;&#125;[0],</span><br><span class="hljs-string">#bad != null ? #list.remove(#bad) : false,</span><br><span class="hljs-string">#bad != null ? &quot;Removed&quot; : &quot;Not found&quot;</span><br><span class="hljs-string">&#x27;</span> -x <span class="hljs-number">3</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765014575689-b91a4523-8230-4d3a-bfc5-c0b8c2c72ea4.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Tomcat-Valve-内存马"><a href="#Tomcat-Valve-内存马" class="headerlink" title="Tomcat Valve 内存马"></a><strong>Tomcat Valve 内存马</strong></h2><h4 id="排查-5"><a href="#排查-5" class="headerlink" title="排查"></a>排查</h4><p>原理：Valve 是 Tomcat 特有组件，位于请求处理管道中（类似 Filter 但更底层）。攻击者通过 <code>Host/Engine/Context.addValve()</code> 注入。</p>
<p>排查思路：</p>
<ul>
<li>同样在web日志中看是否有可疑路由或者可疑header、参数</li>
<li>需直接检查 Tomcat 内部结构。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">获取当前 Web 应用的 StandardContext；<br>通过 context.getPipeline().getFirst() 遍历整个 Valve 链；<br>打印每个 Valve 的类名，反编译识别可疑项<br></code></pre></td></tr></table></figure>

<p>tomcat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs java">sc -d org.apache.catalina.core.ApplicationContextFacade<br><span class="hljs-comment">//得到  classLoaderHash   4361bd48</span><br><br>vmtool --action getInstances \<br>       --classLoaderHash 4361bd48 \<br>       --className org.apache.catalina.core.StandardContext \<br>       --limit <span class="hljs-number">1</span> \<br>       --express <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#ctx=instances[0],#v=#ctx.getPipeline().getFirst(),#l=new java.util.ArrayList(),</span><br><span class="hljs-string">#v!=null?#l.add(#v.getClass().getName()+&quot;|&quot;+#v.getClass().getClassLoader()):null,</span><br><span class="hljs-string">#v=#v!=null?#v.getNext():null,</span><br><span class="hljs-string">#v!=null?#l.add(#v.getClass().getName()+&quot;|&quot;+#v.getClass().getClassLoader()):null,</span><br><span class="hljs-string">#v=#v!=null?#v.getNext():null,</span><br><span class="hljs-string">#v!=null?#l.add(#v.getClass().getName()+&quot;|&quot;+#v.getClass().getClassLoader()):null,</span><br><span class="hljs-string">#v=#v!=null?#v.getNext():null,</span><br><span class="hljs-string">#v!=null?#l.add(#v.getClass().getName()+&quot;|&quot;+#v.getClass().getClassLoader()):null,</span><br><span class="hljs-string">#v=#v!=null?#v.getNext():null,</span><br><span class="hljs-string">#v!=null?#l.add(#v.getClass().getName()+&quot;|&quot;+#v.getClass().getClassLoader()):null,</span><br><span class="hljs-string">#l.isEmpty()?#l.add(&quot;none&quot;):null,#l</span><br><span class="hljs-string">&#x27;</span> -x <span class="hljs-number">3</span><br><br><span class="hljs-comment">//得到</span><br><span class="hljs-meta">@ArrayList</span>[<br>    <span class="hljs-meta">@String</span>[org.apache.catalina.authenticator.NonLoginAuthenticator|java.net.URLClassLoader@4361bd48],<br>    <span class="hljs-meta">@String</span>[org.apache.jsp.shell4_jsp$<span class="hljs-number">1</span>|org.apache.jasper.servlet.JasperLoader@543c3416],<br>    <span class="hljs-meta">@String</span>[org.apache.catalina.core.StandardContextValve|java.net.URLClassLoader@4361bd48],<br>]<br></code></pre></td></tr></table></figure>

<p>或者热加载jsp</p>
<p><img src="/mdimg/avamenshell2/1765031369093-8af6ca88-cdee-4cff-9b8f-808f5ce5f93d.png" srcset="/img/loading.gif" lazyload></p>
<h4 id="清理-5"><a href="#清理-5" class="headerlink" title="清理"></a>清理</h4><p>重启jvm</p>
<p>热加载jsp</p>
<p>clean_valve_memshell.jsp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.reflect.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.servlet.*&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;org.apache.catalina.Valve&quot;</span> %&gt;<br><br>&lt;%<br>    <span class="hljs-type">ServletContext</span> <span class="hljs-variable">servletCtx</span> <span class="hljs-operator">=</span> request.getServletContext();<br>    <span class="hljs-type">StandardContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">appctx</span> <span class="hljs-operator">=</span> servletCtx.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        appctx.setAccessible(<span class="hljs-literal">true</span>);<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">ac</span> <span class="hljs-operator">=</span> appctx.get(servletCtx);<br>        <span class="hljs-type">Field</span> <span class="hljs-variable">stdctx</span> <span class="hljs-operator">=</span> ac.getClass().getDeclaredField(<span class="hljs-string">&quot;context&quot;</span>);<br>        stdctx.setAccessible(<span class="hljs-literal">true</span>);<br>        ctx = (StandardContext) stdctx.get(ac);<br>    &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>        ctx = (StandardContext) servletCtx.getAttribute(<span class="hljs-string">&quot;org.apache.catalina.CONTEXT&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (ctx == <span class="hljs-literal">null</span>) &#123;<br>        out.println(<span class="hljs-string">&quot;&lt;h2&gt;Error: Cannot get StandardContext&lt;/h2&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 获取 Pipeline 的 first Valve</span><br>    <span class="hljs-type">Valve</span> <span class="hljs-variable">firstValve</span> <span class="hljs-operator">=</span> ctx.getPipeline().getFirst();<br>    List&lt;Valve&gt; valveList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-type">Valve</span> <span class="hljs-variable">current</span> <span class="hljs-operator">=</span> firstValve;<br>    <span class="hljs-keyword">while</span> (current != <span class="hljs-literal">null</span>) &#123;<br>        valveList.add(current);<br>        <span class="hljs-keyword">try</span> &#123;<br>            current = current.getNext();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 防止 getNext() 抛异常</span><br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 处理删除请求</span><br>    String[] toRemove = request.getParameterValues(<span class="hljs-string">&quot;remove&quot;</span>);<br>    <span class="hljs-keyword">if</span> (toRemove != <span class="hljs-literal">null</span> &amp;&amp; toRemove.length &gt; <span class="hljs-number">0</span>) &#123;<br>        List&lt;String&gt; removed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>        <span class="hljs-comment">// 注意：Valve 链是单向链表，不能直接按 index remove</span><br>        <span class="hljs-comment">// 所以我们重建整个链（跳过要删除的）</span><br>        List&lt;Valve&gt; newChain = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; valveList.size(); i++) &#123;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldRemove</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">for</span> (String idxStr : toRemove) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (i == Integer.parseInt(idxStr)) &#123;<br>                        shouldRemove = <span class="hljs-literal">true</span>;<br>                        removed.add(<span class="hljs-string">&quot;Index &quot;</span> + i + <span class="hljs-string">&quot; (&quot;</span> + valveList.get(i).getClass().getName() + <span class="hljs-string">&quot;)&quot;</span>);<br>                        <span class="hljs-keyword">break</span>;<br>                    &#125;<br>                &#125; <span class="hljs-keyword">catch</span> (NumberFormatException ignored) &#123;&#125;<br>            &#125;<br>            <span class="hljs-keyword">if</span> (!shouldRemove) &#123;<br>                newChain.add(valveList.get(i));<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-comment">// 重建 Pipeline</span><br>        <span class="hljs-comment">// ========== 重建 Pipeline（使用反射调用 setFirst）==========</span><br>        Class&lt;?&gt; pipelineClass = ctx.getPipeline().getClass(); <span class="hljs-comment">// 应该是 StandardPipeline</span><br>        <span class="hljs-type">Method</span> <span class="hljs-variable">setFirstMethod</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            setFirstMethod = pipelineClass.getDeclaredMethod(<span class="hljs-string">&quot;setFirst&quot;</span>, Valve.class);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException e) &#123;<br>            <span class="hljs-comment">// 兼容旧版？尝试父类</span><br>            setFirstMethod = pipelineClass.getMethod(<span class="hljs-string">&quot;setFirst&quot;</span>, Valve.class);<br>        &#125;<br>        setFirstMethod.setAccessible(<span class="hljs-literal">true</span>);<br><br>        <span class="hljs-keyword">if</span> (newChain.isEmpty()) &#123;<br>            setFirstMethod.invoke(ctx.getPipeline(), (Object) <span class="hljs-literal">null</span>);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-type">Valve</span> <span class="hljs-variable">head</span> <span class="hljs-operator">=</span> newChain.get(<span class="hljs-number">0</span>);<br>            <span class="hljs-type">Valve</span> <span class="hljs-variable">prev</span> <span class="hljs-operator">=</span> head;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; newChain.size(); i++) &#123;<br>                prev.setNext(newChain.get(i));<br>                prev = newChain.get(i);<br>            &#125;<br>            prev.setNext(<span class="hljs-literal">null</span>); <span class="hljs-comment">// 确保结尾</span><br>            setFirstMethod.invoke(ctx.getPipeline(), head);<br>        &#125;<br><br>        out.println(<span class="hljs-string">&quot;&lt;h3&gt;Deleted Valves:&lt;/h3&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;ul&gt;&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String r : removed) &#123;<br>            out.println(<span class="hljs-string">&quot;&lt;li&gt;&quot;</span> + r + <span class="hljs-string">&quot;&lt;/li&gt;&quot;</span>);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;/ul&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&#x27;?&#x27;&gt;Back&lt;/a&gt;&lt;/p&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>%&gt;<br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;Tomcat Valve Cleaner&lt;/title&gt;<br>    &lt;style&gt;<br>        body &#123; font-family: Consolas, monospace; margin: 20px; background: #f9f9f9; &#125;<br>        h2 &#123; color: #c62828; &#125;<br>        table &#123; border-collapse: collapse; width: <span class="hljs-number">100</span>%; margin: 15px <span class="hljs-number">0</span>; &#125;<br>        th, td &#123; border: 1px solid #ddd; padding: 10px; text-align: left; &#125;<br>        input[type=checkbox] &#123; transform: scale(<span class="hljs-number">1.2</span>); &#125;<br>        button &#123; padding: 8px 16px; background: #d32f2f; color: white; border: none; cursor: pointer; &#125;<br>        .suspicious &#123; background-color: #ffebee; color: #c62828; font-weight: bold; &#125;<br>    &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h2&gt;Tomcat Valve Memory Shell Remover&lt;/h2&gt;<br><br>&lt;% <span class="hljs-keyword">if</span> (valveList.isEmpty()) &#123; %&gt;<br>&lt;p&gt;No valves found.&lt;/p&gt;<br>&lt;% &#125; <span class="hljs-keyword">else</span> &#123; %&gt;<br>&lt;form method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>    &lt;table&gt;<br>        &lt;thead&gt;<br>        &lt;tr&gt;<br>            &lt;th&gt;Select&lt;/th&gt;<br>            &lt;th&gt;Index&lt;/th&gt;<br>            &lt;th&gt;Class Name&lt;/th&gt;<br>            &lt;th&gt;ClassLoader&lt;/th&gt;<br>        &lt;/tr&gt;<br>        &lt;/thead&gt;<br>        &lt;tbody&gt;<br>        &lt;%<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; valveList.size(); i++) &#123;<br>                <span class="hljs-type">Valve</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> valveList.get(i);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> v != <span class="hljs-literal">null</span> ? v.getClass().getName() : <span class="hljs-string">&quot;[NULL]&quot;</span>;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">classLoader</span> <span class="hljs-operator">=</span> v != <span class="hljs-literal">null</span> ? v.getClass().getClassLoader().toString() : <span class="hljs-string">&quot;null&quot;</span>;<br>                <span class="hljs-type">boolean</span> <span class="hljs-variable">isSuspicious</span> <span class="hljs-operator">=</span> v != <span class="hljs-literal">null</span> &amp;&amp;<br>                        !classLoader.contains(<span class="hljs-string">&quot;Catalina&quot;</span>) &amp;&amp;<br>                        !classLoader.contains(<span class="hljs-string">&quot;common&quot;</span>) &amp;&amp;<br>                        classLoader.contains(<span class="hljs-string">&quot;WebAppClassLoader&quot;</span>);<br>        %&gt;<br>        &lt;tr &lt;%= isSuspicious ? <span class="hljs-string">&quot;class=&#x27;suspicious&#x27;&quot;</span> : <span class="hljs-string">&quot;&quot;</span> %&gt;&gt;<br>            &lt;td&gt;&lt;input type=<span class="hljs-string">&quot;checkbox&quot;</span> name=<span class="hljs-string">&quot;remove&quot;</span> value=<span class="hljs-string">&quot;&lt;%= i %&gt;&quot;</span>&gt;&lt;/td&gt;<br>            &lt;td&gt;&lt;%= i %&gt;&lt;/td&gt;<br>            &lt;td&gt;&lt;%= className %&gt;&lt;/td&gt;<br>            &lt;td&gt;&lt;%= classLoader %&gt;&lt;/td&gt;<br>        &lt;/tr&gt;<br>        &lt;% &#125; %&gt;<br>        &lt;/tbody&gt;<br>    &lt;/table&gt;<br>    &lt;button type=<span class="hljs-string">&quot;submit&quot;</span> onclick=<span class="hljs-string">&quot;return confirm(&#x27;Confirm deletion of selected valves?&#x27;)&quot;</span>&gt;Delete Selected&lt;/button&gt;<br>&lt;/form&gt;<br>&lt;% &#125; %&gt;<br><br>&lt;hr&gt;<br>&lt;p style=<span class="hljs-string">&quot;color: red; font-size: 12px;&quot;</span>&gt;⚠️ Delete <span class="hljs-built_in">this</span> file immediately after use!&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765031363469-cfb6923c-0ac1-48f6-b9d3-579d46fb457c.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="MBean-内存马"><a href="#MBean-内存马" class="headerlink" title="MBean 内存马"></a><strong>MBean 内存马</strong></h2><h4 id="排查-6"><a href="#排查-6" class="headerlink" title="排查"></a>排查</h4><p>原理：通过 <code>ManagementFactory.getPlatformMBeanServer().registerMBean()</code> 注册恶意 MBean，可通过 JMX 远程调用执行命令。</p>
<p>排查思路：</p>
<ul>
<li>MBean 本身不处理 HTTP 请求，但可作为后门入口（需开启 JMX）。</li>
<li>http异常流量，web日志</li>
<li>检查是否存在可疑 MBean（如含 <code>shell</code>、<code>exec</code> 的 ObjectName）。</li>
<li>排查可疑JMX流量</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">sc *MBean   <span class="hljs-comment">//容易找到jsp生成的内存马</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765087597511-7b5dc778-3c9f-4a74-977e-2b5661b232c5.png" srcset="/img/loading.gif" lazyload></p>
<p>springboot/tomcat</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">ognl <span class="hljs-string">&#x27;@java.lang.management.ManagementFactory@getPlatformMBeanServer().queryNames(null, null).toArray()&#x27;</span><br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765090896887-5c161d7f-7a16-40b6-992c-b6baa14d3e7a.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java">ognl <span class="hljs-string">&#x27;</span><br><span class="hljs-string">#mbs=@java.lang.management.ManagementFactory@getPlatformMBeanServer(), </span><br><span class="hljs-string">#obj=#mbs.getObjectInstance(new javax.management.ObjectName(&quot;DefaultDomain:type=Service,name=MetricsCollector&quot;)), </span><br><span class="hljs-string">#obj.getClassName()</span><br><span class="hljs-string">&#x27;</span><br><span class="hljs-comment">//获取可疑项DefaultDomain:type=Service,name=MetricsCollector的类</span><br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java">ognl <span class="hljs-string">&#x27;@java.lang.management.ManagementFactory@getPlatformMBeanServer().queryNames(null, null).toArray()&#x27;</span> | grep -v <span class="hljs-string">&#x27;Catalina\|java.lang\|JMImplementation\|j2eeType\|com.sun.management&#x27;</span><br><br><span class="hljs-comment">//linux快速去除标准mbean，列出可疑mbean</span><br></code></pre></td></tr></table></figure>

<p>tomcat热加载下面的<code>clean_mbean_memshell.jsp</code>来排查可疑的类，反编译看是否有恶意代码</p>
<p>以下域名（Domain）和类型是 Tomcat / JVM 自带的，属于合法组件：</p>
<table>
<thead>
<tr>
<th>Domain</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td><code>Catalina</code></td>
<td>Tomcat 核心组件（Connector、Context、Valve、Servlet、Filter 等）</td>
</tr>
<tr>
<td><code>java.lang</code></td>
<td>JVM 内置监控（内存、线程、GC、类加载等）</td>
</tr>
<tr>
<td><code>java.nio</code></td>
<td>NIO 缓冲池</td>
</tr>
<tr>
<td><code>com.sun.management</code></td>
<td>HotSpot 诊断命令（如 <code>HotSpotDiagnostic</code><br/>, <code>DiagnosticCommand</code><br/>）</td>
</tr>
<tr>
<td><code>JMImplementation</code></td>
<td>JMX 自身代理</td>
</tr>
<tr>
<td><code>Users</code></td>
<td>Tomcat 用户数据库（<code>tomcat-users.xml</code><br/> 中定义）</td>
</tr>
<tr>
<td><code>java.util.logging</code></td>
<td>日志管理</td>
</tr>
</tbody></table>
<h4 id="清理-6"><a href="#清理-6" class="headerlink" title="清理"></a>清理</h4><p>clean_mbean_memshell.jsp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><code class="hljs java">&lt;%@ page contentType=<span class="hljs-string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="hljs-string">&quot;java&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.lang.management.ManagementFactory&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.management.MBeanServer&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.management.ObjectName&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;javax.management.MBeanInfo&quot;</span> %&gt;<br>&lt;%@ page <span class="hljs-keyword">import</span>=<span class="hljs-string">&quot;java.util.*&quot;</span> %&gt;<br><br>&lt;%!<br>    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">escapeHtml</span><span class="hljs-params">(String s)</span> &#123;<br>        <span class="hljs-keyword">if</span> (s == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>;<br>        <span class="hljs-keyword">return</span> s.replace(<span class="hljs-string">&quot;&amp;&quot;</span>, <span class="hljs-string">&quot;&amp;amp;&quot;</span>)<br>                .replace(<span class="hljs-string">&quot;&lt;&quot;</span>, <span class="hljs-string">&quot;&amp;lt;&quot;</span>)<br>                .replace(<span class="hljs-string">&quot;&gt;&quot;</span>, <span class="hljs-string">&quot;&amp;gt;&quot;</span>)<br>                .replace(<span class="hljs-string">&quot;\&quot;&quot;</span>, <span class="hljs-string">&quot;&amp;quot;&quot;</span>)<br>                .replace(<span class="hljs-string">&quot;&#x27;&quot;</span>, <span class="hljs-string">&quot;&amp;#x27;&quot;</span>);<br>    &#125;<br>%&gt;<br><br>&lt;%<br>    <span class="hljs-type">MBeanServer</span> <span class="hljs-variable">mbs</span> <span class="hljs-operator">=</span> ManagementFactory.getPlatformMBeanServer();<br>    Set&lt;ObjectName&gt; mbeans = mbs.queryNames(<span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br><br>    <span class="hljs-comment">// 存储 &#123; objectName -&gt; className &#125;</span><br>    Map&lt;String, String&gt; mbeanMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (ObjectName name : mbeans) &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">objNameStr</span> <span class="hljs-operator">=</span> name.toString();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;Unknown&quot;</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">MBeanInfo</span> <span class="hljs-variable">info</span> <span class="hljs-operator">=</span> mbs.getMBeanInfo(name);<br>            className = info.getClassName();<br>        &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>            className = <span class="hljs-string">&quot;[Error: &quot;</span> + e.getClass().getSimpleName() + <span class="hljs-string">&quot;]&quot;</span>;<br>        &#125;<br>        mbeanMap.put(objNameStr, className);<br>    &#125;<br><br>    <span class="hljs-comment">// 处理删除请求（只传 ObjectName）</span><br>    String[] toRemove = request.getParameterValues(<span class="hljs-string">&quot;remove&quot;</span>);<br>    <span class="hljs-keyword">if</span> (toRemove != <span class="hljs-literal">null</span> &amp;&amp; toRemove.length &gt; <span class="hljs-number">0</span>) &#123;<br>        List&lt;String&gt; removed = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (String nameStr : toRemove) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">ObjectName</span> <span class="hljs-variable">objName</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectName</span>(nameStr);<br>                <span class="hljs-keyword">if</span> (mbs.isRegistered(objName)) &#123;<br>                    mbs.unregisterMBean(objName);<br>                    removed.add(nameStr);<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception ex) &#123;<br>                <span class="hljs-comment">// ignore</span><br>            &#125;<br>        &#125;<br><br>        out.println(<span class="hljs-string">&quot;&lt;h3&gt;Deleted MBeans:&lt;/h3&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;ul&gt;&quot;</span>);<br>        <span class="hljs-keyword">for</span> (String r : removed) &#123;<br>            out.println(<span class="hljs-string">&quot;&lt;li&gt;&quot;</span> + escapeHtml(r) + <span class="hljs-string">&quot;&lt;/li&gt;&quot;</span>);<br>        &#125;<br>        out.println(<span class="hljs-string">&quot;&lt;/ul&gt;&quot;</span>);<br>        out.println(<span class="hljs-string">&quot;&lt;p&gt;&lt;a href=&#x27;?&#x27;&gt;Back&lt;/a&gt;&lt;/p&gt;&quot;</span>);<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>%&gt;<br><br>&lt;!DOCTYPE html&gt;<br>&lt;html&gt;<br>&lt;head&gt;<br>    &lt;meta charset=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;<br>    &lt;title&gt;MBean <span class="hljs-title function_">Cleaner</span> <span class="hljs-params">(with Class)</span>&lt;/title&gt;<br>    &lt;style&gt;<br>        body &#123; font-family: Consolas, monospace; margin: 20px; background: #f9f9f9; &#125;<br>        h2 &#123; color: #c62828; &#125;<br>        table &#123; border-collapse: collapse; width: <span class="hljs-number">100</span>%; margin: 15px <span class="hljs-number">0</span>; &#125;<br>        th, td &#123; border: 1px solid #ddd; padding: 10px; text-align: left; word-<span class="hljs-keyword">break</span>: <span class="hljs-keyword">break</span>-all; &#125;<br>        input[type=checkbox] &#123; transform: scale(<span class="hljs-number">1.2</span>); &#125;<br>        button &#123; padding: 8px 16px; background: #d32f2f; color: white; border: none; cursor: pointer; &#125;<br>        .classname &#123; color: #2e7d32; font-weight: bold; &#125;<br>    &lt;/style&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h2&gt;MBean Memory Shell <span class="hljs-title function_">Remover</span> <span class="hljs-params">(with Class Name)</span>&lt;/h2&gt;<br><br>&lt;% <span class="hljs-keyword">if</span> (mbeanMap.isEmpty()) &#123; %&gt;<br>&lt;p&gt;No MBeans found.&lt;/p&gt;<br>&lt;% &#125; <span class="hljs-keyword">else</span> &#123; %&gt;<br>&lt;form method=<span class="hljs-string">&quot;post&quot;</span>&gt;<br>    &lt;table&gt;<br>        &lt;thead&gt;<br>        &lt;tr&gt;<br>            &lt;th&gt;Select&lt;/th&gt;<br>            &lt;th&gt;ObjectName&lt;/th&gt;<br>            &lt;th&gt;Class Name&lt;/th&gt;<br>        &lt;/tr&gt;<br>        &lt;/thead&gt;<br>        &lt;tbody&gt;<br>        &lt;% <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : mbeanMap.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">objName</span> <span class="hljs-operator">=</span> entry.getKey();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">className</span> <span class="hljs-operator">=</span> entry.getValue(); %&gt;<br>        &lt;tr&gt;<br>            &lt;td&gt;&lt;input type=<span class="hljs-string">&quot;checkbox&quot;</span> name=<span class="hljs-string">&quot;remove&quot;</span> value=<span class="hljs-string">&quot;&lt;%= escapeHtml(objName) %&gt;&quot;</span>&gt;&lt;/td&gt;<br>            &lt;td&gt;&lt;%= escapeHtml(objName) %&gt;&lt;/td&gt;<br>            &lt;td class=<span class="hljs-string">&quot;classname&quot;</span>&gt;&lt;%= escapeHtml(className) %&gt;&lt;/td&gt;<br>        &lt;/tr&gt;<br>        &lt;% &#125; %&gt;<br>        &lt;/tbody&gt;<br>    &lt;/table&gt;<br>    &lt;button type=<span class="hljs-string">&quot;submit&quot;</span> onclick=<span class="hljs-string">&quot;return confirm(&#x27;Confirm deletion of selected MBeans?&#x27;)&quot;</span>&gt;Delete Selected&lt;/button&gt;<br>&lt;/form&gt;<br>&lt;% &#125; %&gt;<br><br>&lt;hr&gt;<br>&lt;p style=<span class="hljs-string">&quot;color: red; font-size: 12px;&quot;</span>&gt;⚠️ Delete <span class="hljs-built_in">this</span> file immediately after use!&lt;/p&gt;<br>&lt;p style=<span class="hljs-string">&quot;font-size: 12px; color: #555;&quot;</span>&gt;<br>    💡 Tip: Use Arthas command: &lt;code&gt;jad &amp;lt;ClassName&amp;gt;&lt;/code&gt; to decompile suspicious classes.<br>&lt;/p&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765088769755-5bf9887a-09eb-4e28-8d11-b53752515e05.png" srcset="/img/loading.gif" lazyload></p>
<h2 id="Agent-内存马"><a href="#Agent-内存马" class="headerlink" title="Agent 内存马"></a><strong>Agent 内存马</strong></h2><h4 id="排查-7"><a href="#排查-7" class="headerlink" title="排查"></a>排查</h4><p>原理：通过 <code>-javaagent</code> 启动参数，或利用 <code>Attach API</code>（如 <code>com.sun.tools.attach.VirtualMachine</code>）动态加载 agent，在字节码层面插桩（如修改 <code>java.lang.ProcessBuilder.start</code>）。</p>
<p>排查思路：</p>
<ul>
<li>Agent 不在应用 ClassLoader 中，常规方式无法看到。</li>
<li>重点检查 JVM 启动参数和已加载的 agent。</li>
<li>http流量、web日志</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"># 反编译 ApplicationFilterChain 查看是否有恶意代码<br>jad org.apache.catalina.core.ApplicationFilterChain<br><br>jps -v<br># 或<br>ps aux | grep tomcat<br>#看是否包含 -javaagent:xxx.jar（但高级攻击者会清除参数）<br><br>#监控异常网络连接（辅助判断）<br>#Agent 内存马通常会回连 C2：<br># 查看 Tomcat 进程的网络连接<br>lsof -p $(pgrep -f catalina) | grep ESTABLISHED<br># 或<br>netstat -antp | grep $(pgrep -f catalina)<br><br></code></pre></td></tr></table></figure>

<h4 id="清理-7"><a href="#清理-7" class="headerlink" title="清理"></a>清理</h4><p>重启jvm，然后禁止attach  jvm</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"># Linux (catalina.sh)<br>CATALINA_OPTS=<span class="hljs-string">&quot;$CATALINA_OPTS -XX:+DisableAttachMechanism&quot;</span><br><br>:: Windows (catalina.bat)<br>set <span class="hljs-string">&quot;CATALINA_OPTS=%CATALINA_OPTS% -XX:+DisableAttachMechanism&quot;</span><br></code></pre></td></tr></table></figure>

<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><p>Arthas 本质是通过 Java Agent Attach 机制注入到目标 JVM 的。而像 冰蝎（Behinder）、哥斯拉（Godzilla）的一些高级 WebShell，会主动 破坏 Attach 机制（删除<code>.java_pid&lt;pid&gt;</code>导致无法attach jvm），以阻止使用 Arthas等工具进行分析。</p>
<p><img src="/mdimg/avamenshell2/1765091683237-b1541906-2c6e-479e-b9c8-07549d209090.png" srcset="/img/loading.gif" lazyload></p>
<p>这种情况下需要通过dump内存的方法去排查，毕竟内存马始终存在于内存。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs java">jmap -dump:format=b,file=&lt;filename&gt; &lt;pid&gt;<br></code></pre></td></tr></table></figure>

<p><img src="/mdimg/avamenshell2/1765006927688-5ea46fcb-4860-44e2-8dfa-82b580b00950.png" srcset="/img/loading.gif" lazyload></p>
<p><img src="/mdimg/avamenshell2/1765006898073-90aba0eb-7278-4553-a0cb-aab2ab77db92.png" srcset="/img/loading.gif" lazyload></p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E7%A0%94%E7%A9%B6/" class="category-chain-item">研究</a>
  
  
    <span>></span>
    
  <a href="/categories/%E7%A0%94%E7%A9%B6/%E7%AC%94%E8%AE%B0/" class="category-chain-item">笔记</a>
  
  

  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E7%AC%94%E8%AE%B0/" class="print-no-link">#笔记</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>JAVA内存马查杀</div>
      <div>http://example.com/2025/12/07/JAVA内存马查杀/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>J_0k3r</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2025年12月7日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              BY J_0K3R 
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/11/27/%E7%AC%AC16%E5%B1%8A%E6%9E%81%E5%AE%A2%E5%A4%A7%E6%8C%91%E6%88%98-web/" title="第16届极客大挑战-web">
                        <span class="hidden-mobile">第16届极客大挑战-web</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
      <div class="col-lg-7 mx-auto nopadding-x-md">
        <div class="container custom mx-auto">
           <!--音乐--> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css"> <script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/meting@1.2/dist/Meting.min.js"></script> <div id="player" class="aplayer aplayer-withlist aplayer-fixed" data-id="9723733050" data-server="netease" data-type="playlist" autoplay="true" data-order="list"  data-fixed="true" data-listfolded="true" data-theme="#2D8CF0"></div> 
        </div>
      </div>
    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       J_0k3r <i class="iconfont icon-love"></i> Hor1zon<br /> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        总访问量 
        <span id="busuanzi_value_site_pv"></span>
         次
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        总访客数 
        <span id="busuanzi_value_site_uv"></span>
         人
      </span>
    
    
  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
